<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>AMY UNIVERSE</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600&display=swap');
  *{margin:0;padding:0;box-sizing:border-box;}
  :root{
    --bg-0:#0b0e14;--bg-1:#111620;--bg-2:#171d2a;--bg-3:#1e2536;
    --border:#2a3345;--border-light:#3a4560;
    --text-0:#f0f3f8;--text-1:#c5ccdb;--text-2:#8892a6;--text-3:#5a6478;
    --accent:#6c8cff;--accent-dim:rgba(108,140,255,.12);
    --green:#3dd68c;--green-dim:rgba(61,214,140,.12);
    --yellow:#f5c542;--yellow-dim:rgba(245,197,66,.12);
    --red:#f5564a;--red-dim:rgba(245,86,74,.12);
    --orange:#f5944a;--orange-dim:rgba(245,148,74,.12);
    --purple:#b07aff;--purple-dim:rgba(176,122,255,.12);
    --radius:12px;--radius-sm:8px;
  }
  body{background:var(--bg-0);color:var(--text-0);font-family:'Inter',-apple-system,sans-serif;min-height:100vh;min-height:100dvh;line-height:1.5;-webkit-text-size-adjust:100%;padding-bottom:env(safe-area-inset-bottom,0);overflow-x:hidden;}

  /* TOPBAR */
  .topbar{display:flex;align-items:center;justify-content:space-between;padding:0 28px;padding-top:env(safe-area-inset-top,0);padding-left:max(28px,env(safe-area-inset-left,0));padding-right:max(28px,env(safe-area-inset-right,0));min-height:54px;background:var(--bg-1);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:100;backdrop-filter:blur(12px);}
  .topbar-left{display:flex;align-items:center;gap:14px;}
  .topbar-logo{font-size:16px;font-weight:800;letter-spacing:.5px;display:flex;align-items:center;gap:8px;}
  .topbar-logo .brand{background:linear-gradient(135deg,var(--accent),var(--purple));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
  .topbar-logo .ver{color:var(--text-3);font-weight:400;font-size:11px;letter-spacing:0;-webkit-text-fill-color:unset;background:none;}
  .topbar-right{display:flex;align-items:center;gap:14px;}
  .topbar-time{font-family:'JetBrains Mono',monospace;font-size:12px;color:var(--text-3);}
  .conn-badge{font-size:12px;color:var(--text-2);display:flex;align-items:center;gap:6px;padding:5px 12px;background:var(--bg-2);border-radius:20px;border:1px solid var(--border);cursor:pointer;transition:all .15s;}
  .conn-badge:hover{border-color:var(--accent);color:var(--text-0);}
  .conn-badge.restarting{border-color:var(--yellow);animation:pulse 1s ease-in-out infinite;}
  .dot{width:7px;height:7px;border-radius:50%;}
  .dot.on{background:var(--green);box-shadow:0 0 6px var(--green);animation:pulse 2s ease-in-out infinite;}
  .dot.off{background:var(--red);box-shadow:0 0 6px var(--red);}
  .dot.connecting{background:var(--yellow);box-shadow:0 0 6px var(--yellow);animation:pulse 1s ease-in-out infinite;}
  @keyframes pulse{0%,100%{opacity:1;}50%{opacity:.4;}}

  /* DASHBOARD BODY */
  .dashboard-body{width:100%;padding:0 28px 36px;overflow-x:hidden;box-sizing:border-box;}

  /* PAGE HEADER ‚Äî Î©îÏù∏ Í∑∏Î¶¨Îìú 5fr:8fr ÏôÄ ÎèôÏùºÌïú grid Ïª¨Îüº ÏÇ¨Ïö© */
  .page-header{display:grid;grid-template-columns:minmax(0,5fr) minmax(0,8fr);gap:16px;padding:20px 0 0;}
  .stat-strip{display:flex;gap:14px;min-width:0;}
  .s-card{background:var(--bg-1);border:1px solid var(--border);border-radius:var(--radius);padding:18px 20px;display:flex;align-items:flex-start;gap:14px;transition:border-color .2s,box-shadow .2s;flex:1;min-width:0;}
  .s-card:hover{border-color:var(--border-light);box-shadow:0 4px 20px rgba(0,0,0,.18);}
  .s-icon{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;margin-top:2px;}
  .s-label{font-size:10px;color:var(--text-3);font-weight:600;text-transform:uppercase;letter-spacing:.7px;margin-bottom:5px;}
  .s-value{font-size:22px;font-weight:800;letter-spacing:-.7px;line-height:1.2;}
  .s-sub{font-size:11px;color:var(--text-3);margin-top:4px;}
  .s-quota{margin-top:10px;}
  .s-quota-bar{width:100%;height:3px;background:var(--bg-0);border-radius:2px;overflow:hidden;}
  .s-quota-fill{height:100%;border-radius:2px;transition:width 1.5s ease;}
  .s-quota-text{font-size:10px;font-family:'JetBrains Mono',monospace;color:var(--text-3);margin-top:5px;display:flex;justify-content:space-between;}

  /* MAIN GRID */
  .main-grid{display:grid;grid-template-columns:minmax(0,5fr) minmax(0,8fr);gap:16px;width:100%;max-width:100%;min-width:0;padding:16px 0 0;}
  .section{padding:22px 20px;border:1px solid var(--border);border-radius:var(--radius);background:var(--bg-1);min-width:0;max-width:100%;}
  .section.full{grid-column:1/-1;margin-top:16px;}
  .section.org-section{min-width:0;overflow:hidden;}
  .section.chat-section{display:flex;flex-direction:column;}
  .sec-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;}
  .sec-title{font-size:13px;font-weight:700;display:flex;align-items:center;gap:7px;letter-spacing:-.1px;color:var(--text-1);}
  .sec-badge{font-size:11px;color:var(--text-3);background:var(--bg-3);padding:3px 10px;border-radius:20px;border:1px solid var(--border);font-weight:500;}

  /* ORG CHART */
  .org{display:flex;flex-direction:column;align-items:center;padding:8px 0;gap:0;width:100%;max-width:100%;min-width:0;transform-origin:center center;overflow:hidden;}
  .org-node{background:var(--bg-2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:10px 14px;text-align:center;cursor:pointer;transition:all .2s;position:relative;min-width:110px;max-width:160px;flex-shrink:0;}
  .org-node:hover{border-color:var(--border-light);transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,0,0,.25);}
  .org-node::before{content:'';position:absolute;top:0;left:0;width:100%;height:3px;border-radius:var(--radius-sm) var(--radius-sm) 0 0;background:var(--c,var(--accent));}
  .org-node.boss-node{min-width:140px;max-width:180px;padding:12px 18px;}
  .org-node.boss-node .org-emoji{font-size:26px;}
  .org-node.boss-node .org-name{font-size:15px;}
  .org-top-row{display:grid;grid-template-columns:1fr auto 1fr;align-items:start;justify-items:center;gap:12px;width:100%;min-width:0;}
  .org-boss-left{justify-self:end;}
  .org-boss-center{justify-self:center;}
  .org-boss-right{justify-self:start;}
  .vline{width:2px;height:22px;background:var(--border-light);flex-shrink:0;}
  .hline{height:2px;background:var(--border-light);flex-shrink:0;}
  .org-rows{display:flex;flex-direction:column;align-items:center;gap:0;width:100%;}
  .team-row{display:flex;justify-content:center;align-items:flex-start;gap:14px;flex-wrap:wrap;max-width:100%;}
  .team-col{display:flex;flex-direction:column;align-items:center;min-width:110px;}
  .vline-sm{width:2px;height:18px;background:var(--border-light);flex-shrink:0;}
  .org-emoji{font-size:22px;margin-bottom:3px;}
  .org-name{font-weight:700;font-size:13px;}
  .org-role{font-size:11px;color:var(--text-2);font-weight:500;}
  .org-model{font-size:10px;font-family:'JetBrains Mono',monospace;color:var(--text-3);margin-top:2px;}
  .org-node .ind{position:absolute;top:7px;right:7px;width:8px;height:8px;border-radius:50%;}

  /* (agent-list Ï†úÍ±∞Îê®) */
  .pbar{width:90px;height:4px;background:var(--bg-0);border-radius:2px;overflow:hidden;}
  .pfill{height:100%;border-radius:2px;transition:width 1.5s ease;}

  /* API GRID */
  .api-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-bottom:18px;align-items:stretch;min-width:0;}
  .api-card{background:var(--bg-2);border:1px solid var(--border);border-radius:var(--radius);padding:14px 12px;text-align:center;transition:border-color .2s,box-shadow .2s;position:relative;overflow:hidden;display:flex;flex-direction:column;}
  .api-card:hover{border-color:var(--border-light);box-shadow:0 4px 16px rgba(0,0,0,.2);}
  .api-card::before{content:'';position:absolute;top:0;left:0;width:100%;height:3px;background:var(--c,var(--accent));}
  .api-card .emoji{font-size:20px;margin-bottom:3px;}
  .api-card .name{font-weight:700;font-size:12px;margin-bottom:1px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .api-card .model{font-size:9px;font-family:'JetBrains Mono',monospace;color:var(--text-3);margin-bottom:6px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .api-card .card-body{margin-top:auto;}
  .ubar{width:100%;height:3px;background:var(--bg-0);border-radius:2px;overflow:hidden;margin:5px 0 3px;}
  .ufill{height:100%;border-radius:2px;transition:width 2s ease;}
  .ufill.low{background:linear-gradient(90deg,#2a9d5c,var(--green));}
  .ufill.mid{background:linear-gradient(90deg,#d4a017,var(--yellow));}
  .ufill.high{background:linear-gradient(90deg,#d46317,var(--orange));}
  .ufill.crit{background:linear-gradient(90deg,#c0392b,var(--red));animation:bpulse 1.5s ease-in-out infinite;}
  @keyframes bpulse{0%,100%{opacity:1;}50%{opacity:.7;}}
  .upct{font-size:10px;font-weight:600;font-family:'JetBrains Mono',monospace;text-align:right;}
  .api-row{display:flex;justify-content:space-between;align-items:center;font-size:11px;padding:3px 0;border-top:1px solid var(--border);}
  .api-row:first-of-type{border-top:none;}
  .api-row .l{color:var(--text-2);font-size:10px;}
  .api-row .v{font-weight:700;font-family:'JetBrains Mono',monospace;font-size:11px;}
  .api-alert{display:inline-flex;align-items:center;gap:4px;font-size:10px;font-weight:600;padding:2px 8px;border-radius:4px;margin-top:4px;}

  /* BOTTOM SPLIT (5:5) */
  .bottom-split{display:grid;grid-template-columns:1fr 1fr;gap:20px;align-items:start;}
  .bottom-left,.bottom-right{min-width:0;}
  .bottom-left .sec-header{margin-bottom:16px;}
  /* API Ïπ¥Îìú Ìïú Ï§ÑÏóê 3Í∞ú Í≥†Ï†ï */
  .bottom-left .api-grid{grid-template-columns:repeat(3,1fr);gap:10px;}

  /* COST CHART */
  .cost-chart{background:var(--bg-2);border:1px solid var(--border);border-radius:var(--radius);padding:20px;min-width:0;}
  .cost-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;}
  .cost-title{font-size:12px;font-weight:600;color:var(--text-2);text-transform:uppercase;letter-spacing:.5px;}
  .chart-area{position:relative;height:300px;overflow:hidden;}
  .chart-canvas{width:100%;height:100%;}
  .chart-x{display:flex;justify-content:space-between;font-size:10px;font-family:'JetBrains Mono',monospace;color:var(--text-3);padding:4px 40px 0;}

  /* MODAL */
  .modal-bg{display:none;position:fixed;inset:0;background:rgba(0,0,0,.65);z-index:200;backdrop-filter:blur(4px);}
  .modal-bg.show{display:flex;align-items:center;justify-content:center;}
  .modal{background:var(--bg-1);border:1px solid var(--border);border-radius:16px;width:560px;max-height:85vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.5);animation:modin .25s ease-out;}
  @keyframes modin{from{opacity:0;transform:scale(.95) translateY(10px);}to{opacity:1;transform:scale(1) translateY(0);}}
  .m-top{padding:24px 28px 20px;border-bottom:1px solid var(--border);display:flex;align-items:flex-start;gap:16px;}
  .m-ava{width:56px;height:56px;border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:30px;border:2px solid var(--border);background:var(--bg-2);flex-shrink:0;}
  .m-info{flex:1;}
  .m-name{font-size:20px;font-weight:800;display:flex;align-items:center;gap:8px;}
  .m-role{font-size:13px;color:var(--text-2);margin-top:2px;}
  .m-model{font-size:11px;font-family:'JetBrains Mono',monospace;color:var(--text-3);margin-top:4px;}
  .m-close{background:var(--bg-3);border:1px solid var(--border);color:var(--text-2);width:32px;height:32px;border-radius:8px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:16px;transition:all .15s;}
  .m-close:hover{background:var(--red-dim);color:var(--red);}
  .m-body{padding:20px 28px 24px;}
  .m-sec{margin-bottom:20px;}
  .m-sec-t{font-size:12px;font-weight:600;color:var(--text-2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:10px;display:flex;align-items:center;gap:6px;}
  .chip-grid{display:flex;flex-wrap:wrap;gap:6px;}
  .chip{font-size:11px;padding:4px 10px;border-radius:6px;font-weight:500;border:1px solid;}
  .chip.ok{background:var(--green-dim);color:var(--green);border-color:rgba(61,214,140,.25);}
  .chip.no{background:var(--red-dim);color:var(--red);border-color:rgba(245,86,74,.25);text-decoration:line-through;opacity:.7;}
  .mini-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
  .mini{background:var(--bg-2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:12px;text-align:center;}
  .mini .l{font-size:11px;color:var(--text-2);margin-bottom:4px;}
  .mini .v{font-size:18px;font-weight:800;font-family:'JetBrains Mono',monospace;}

  /* RESPONSIVE */
  @media(max-width:1500px){.api-grid{grid-template-columns:repeat(4,1fr);}}
  @media(max-width:1200px){.api-grid{grid-template-columns:repeat(3,1fr);}}
  @media(max-width:1100px){
    .dashboard-body{padding:0 20px 28px;}
    .main-grid{grid-template-columns:1fr;gap:12px;}
    .page-header{grid-template-columns:1fr;gap:12px;}
    .stat-strip{gap:12px;}
    .bottom-split{grid-template-columns:1fr;gap:14px;}
    .api-grid{grid-template-columns:repeat(auto-fill,minmax(130px,1fr));}
    .topbar{padding:0 20px;}
    .section{padding:18px 14px;}
    .chart-area{height:220px;}
  }
  @media(max-width:768px){
    .dashboard-body{padding:0 16px 24px;}
    .page-header{grid-template-columns:1fr;gap:10px;padding:14px 0 0;}
    .stat-strip{flex-direction:column;gap:10px;}
    .s-card{padding:12px 14px;gap:10px;}
    .s-icon{width:34px;height:34px;font-size:16px;}
    .s-value{font-size:18px;}
    .topbar{height:52px;padding:0 16px;}
    .topbar-logo{font-size:15px;}
    .topbar-logo .ver{display:none;}
    .topbar-right{gap:10px;}
    .conn-badge{font-size:11px;padding:5px 10px;}
    .topbar-time{font-size:11px;}
    .section{padding:14px 12px;}
    .section.full{margin-top:12px;}
    .sec-header{flex-wrap:wrap;gap:6px;margin-bottom:12px;}
    .org{padding:8px 0;}
    .org-top-row{grid-template-columns:1fr;gap:10px;justify-items:center;}
    .org-boss-left,.org-boss-right,.org-boss-center{justify-self:center;}
    .org-node{min-width:90px;max-width:140px;padding:9px 12px;}
    .org-node.boss-node{min-width:130px;max-width:170px;padding:11px 16px;}
    .team-row{flex-wrap:wrap;justify-content:center;gap:10px;}
    .team-col{min-width:90px;}
    .api-grid{grid-template-columns:repeat(2,1fr);gap:8px;}
    .api-card{padding:10px 10px;}
    .cost-chart{padding:14px;}
    .chart-area{height:150px;}
    .chat-tabs{overflow-x:auto;-webkit-overflow-scrolling:touch;padding-bottom:6px;scrollbar-width:none;-ms-overflow-style:none;}
    .chat-tabs::-webkit-scrollbar{display:none;}
    .chat-tab{padding:7px 11px;font-size:11px;flex-shrink:0;}
    .chat-msgs{max-height:calc(100vh - 300px);min-height:180px;}
    .chat-msg{flex-wrap:wrap;padding:9px 11px;gap:7px;}
    .chat-msg .cm-ava{width:24px;height:24px;font-size:12px;}
    .chat-msg .cm-text{font-size:11px;}
    .modal{width:calc(100% - 24px);max-width:100%;margin:12px;max-height:90vh;}
    .m-top{padding:18px 14px;flex-wrap:wrap;}
    .m-ava{width:46px;height:46px;font-size:22px;}
    .m-name{font-size:17px;}
    .m-body{padding:14px;}
    .mini-grid{grid-template-columns:1fr;}
    .rl-panel .rl-card{min-width:140px;}
  }
  @media(max-width:480px){
    .dashboard-body{padding:0 12px 20px;}
    .api-grid{grid-template-columns:repeat(2,1fr);}
    .s-value{font-size:16px;}
    .section{padding:12px 10px;}
    .org-node{min-width:80px;max-width:120px;}
  }

  /* RATE LIMIT PANEL (inside page-header) */
  .rl-panel{background:var(--bg-1);border:1px solid var(--border);border-radius:var(--radius);padding:18px 22px;display:flex;flex-direction:column;gap:12px;min-width:0;}
  .rl-panel-title{font-size:10px;font-weight:700;color:var(--text-3);text-transform:uppercase;letter-spacing:.7px;}
  .rate-providers{display:flex;gap:10px;flex-wrap:wrap;flex:1;}
  /* ÌîÑÎ°úÎ∞îÏù¥Îçî Ïπ¥Îìú */
  .rl-card{background:var(--bg-2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:12px 16px;flex:1;min-width:180px;display:flex;flex-direction:column;gap:6px;transition:border-color .3s;}
  .rl-card.rl-danger{border-color:rgba(245,86,74,.5);background:rgba(245,86,74,.06);}
  .rl-card.rl-warn{border-color:rgba(245,148,74,.4);}
  .rl-card.rl-ok{border-color:var(--border);}
  .rl-card-header{display:flex;align-items:center;gap:5px;}
  .rl-icon{font-size:13px;line-height:1;}
  .rl-name{font-size:13px;font-weight:700;color:var(--text-0);}
  .rl-provider{font-size:10px;color:var(--text-3);margin-left:2px;}
  .rl-status-row{display:flex;align-items:center;gap:8px;flex-wrap:wrap;}
  .rl-badge-danger{background:var(--red-dim);border:1px solid var(--red);color:var(--red);border-radius:5px;padding:2px 8px;font-size:11px;font-weight:700;animation:pulse 1.2s ease-in-out infinite;white-space:nowrap;}
  .rl-badge-ok{background:var(--green-dim);border:1px solid rgba(61,214,140,.3);color:var(--green);border-radius:5px;padding:2px 8px;font-size:11px;font-weight:700;white-space:nowrap;}
  .rl-countdown{font-family:'JetBrains Mono',monospace;font-size:11px;white-space:nowrap;}
  .rl-countdown.danger{color:var(--red);font-weight:700;}
  .rl-countdown.ok{color:var(--text-3);}
  .rl-bar-row{display:flex;align-items:center;gap:6px;}
  .rl-win-label{font-size:10px;color:var(--text-3);min-width:20px;}
  .rl-bar{flex:1;height:5px;background:var(--bg-0);border-radius:3px;overflow:hidden;min-width:50px;}
  .rl-bar-fill{height:100%;border-radius:3px;transition:width 1.2s ease,background .5s ease;}
  .rl-pct{font-family:'JetBrains Mono',monospace;font-size:11px;font-weight:700;min-width:30px;text-align:right;}
  .rl-sub{font-size:10px;color:var(--text-3);}

  /* CHAT LOG */
  .chat-tabs{display:flex;gap:4px;overflow-x:auto;padding-bottom:10px;border-bottom:1px solid var(--border);margin-bottom:14px;flex-shrink:0;}
  .chat-tab{padding:6px 14px;border-radius:20px;font-size:12px;font-weight:600;cursor:pointer;white-space:nowrap;border:1px solid var(--border);background:var(--bg-2);color:var(--text-2);transition:all .15s;user-select:none;pointer-events:auto;position:relative;z-index:2;min-height:34px;display:inline-flex;align-items:center;justify-content:center;-webkit-tap-highlight-color:transparent;}
  .chat-tab:hover{border-color:var(--accent);color:var(--text-1);}
  .chat-tab.active{background:var(--accent-dim);border-color:var(--accent);color:var(--accent);}
  .chat-tab .tab-dot{display:inline-block;width:6px;height:6px;border-radius:50%;margin-right:5px;pointer-events:none;}
  .chat-msgs{flex:1;min-height:300px;max-height:calc(100vh - 340px);overflow-y:scroll;display:flex;flex-direction:column;gap:6px;padding:2px 0;min-width:0;}
  .chat-msg{display:flex;gap:10px;padding:10px 14px;border-radius:var(--radius-sm);background:var(--bg-2);border:1px solid var(--border);position:relative;transition:border-color .15s;}
  .chat-msg:hover{border-color:var(--border-light);}
  .chat-msg.user{border-left:2px solid var(--accent);}
  .chat-msg.assistant{border-left:2px solid var(--green);}
  .chat-msg.spawn{border-left:2px solid var(--orange);background:rgba(245,148,74,.05);}
  .chat-msg.tool,.chat-msg.toolResult{border-left:2px solid var(--purple);background:rgba(176,122,255,.05);}
  .chat-msg .cm-ava{flex-shrink:0;width:26px;height:26px;border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:13px;background:var(--bg-3);}
  .chat-msg .cm-body{flex:1;min-width:0;}
  .chat-msg .cm-head{display:flex;align-items:center;gap:6px;margin-bottom:3px;}
  .chat-msg .cm-role{font-size:10px;font-weight:700;letter-spacing:.4px;}
  .chat-msg .cm-agent-tag{font-size:9px;padding:1px 6px;border-radius:10px;font-weight:600;}
  .chat-msg .cm-text{font-size:12px;color:var(--text-1);line-height:1.55;white-space:pre-wrap;word-break:break-word;}
  .chat-msg .cm-time{font-size:10px;color:var(--text-3);font-family:'JetBrains Mono',monospace;flex-shrink:0;align-self:flex-start;margin-top:1px;}
  .chat-empty{text-align:center;padding:48px 20px;color:var(--text-3);font-size:13px;}
  .chat-divider{display:flex;align-items:center;gap:10px;padding:4px 0;color:var(--text-3);font-size:10px;font-weight:600;}
  .chat-divider::before,.chat-divider::after{content:'';flex:1;height:1px;background:var(--border);}
  .chat-arrow{font-size:11px;color:var(--orange);font-weight:700;margin:0 2px;}

  /* Empty state */
  .empty{text-align:center;padding:40px 20px;color:var(--text-3);}
  .empty .icon{font-size:48px;margin-bottom:12px;opacity:.5;}
  .empty .msg{font-size:14px;}

  ::-webkit-scrollbar{width:5px;}::-webkit-scrollbar-track{background:transparent;}::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px;}
</style>
</head>
<body>

<div class="topbar">
  <div class="topbar-left">
    <div class="topbar-logo">üê± <span class="brand">AMY UNIVERSE</span> <span class="ver" id="gwVersion"></span></div>
  </div>
  <div class="topbar-right">
    <div class="conn-badge" id="connBadge" onclick="onConnBadgeClick()" title="ÌÅ¥Î¶≠ÌïòÏó¨ Gateway Ïû¨ÏãúÏûë">
      <div class="dot" id="connDot"></div>
      <span id="connLabel">Ïó∞Í≤∞ Ï§ë...</span>
    </div>
    <div class="topbar-time" id="clock"></div>
  </div>
</div>

<div class="dashboard-body">

  <!-- ‚îÄ‚îÄ ÏÉÅÎã®: Ïä§ÌÉØ + API ÌïúÎèÑ ‚îÄ‚îÄ -->
  <div class="page-header">
    <div class="stat-strip">
      <div class="s-card">
        <div class="s-icon" style="background:var(--green-dim);">üí¨</div>
        <div style="flex:1;min-width:0;">
          <div class="s-label">ÌôúÏÑ± ÏÑ∏ÏÖò</div>
          <div class="s-value" id="sSessionCount">‚Äî</div>
          <div class="s-sub" id="sSessionSub">‚Äî</div>
        </div>
      </div>
      <div class="s-card">
        <div class="s-icon" style="background:var(--yellow-dim);">ü™ô</div>
        <div style="flex:1;min-width:0;">
          <div class="s-label">Claude ÌÜ†ÌÅ∞ &nbsp;<span style="font-size:9px;color:var(--text-3);text-transform:none;letter-spacing:0;font-weight:400;">Max 20x</span></div>
          <div class="s-value" id="sTokens">‚Äî</div>
          <div class="s-sub" id="sTokenCost">‚Äî</div>
          <div class="s-quota" id="sQuota">
            <div class="s-quota-bar"><div class="s-quota-fill" id="sQuotaFill" style="width:0%;background:var(--green);"></div></div>
            <div class="s-quota-text"><span id="sQuotaUsed">‚Äî</span><span id="sQuotaLimit">‚Äî</span></div>
          </div>
        </div>
      </div>
      <div class="s-card">
        <div class="s-icon" style="background:var(--purple-dim);">üì°</div>
        <div style="flex:1;min-width:0;">
          <div class="s-label">Ï±ÑÎÑê ÏÉÅÌÉú</div>
          <div class="s-value" id="sChannel">‚Äî</div>
          <div class="s-sub" id="sChannelSub">‚Äî</div>
        </div>
      </div>
    </div>

    <!-- API ÌïúÎèÑ Ìå®ÎÑê (Îç∞Ïù¥ÌÑ∞ ÏûàÏùÑ ÎïåÎßå ÌëúÏãú) -->
    <div class="rl-panel" id="rateLimitBar" style="display:none;">
      <div class="rl-panel-title">‚ö° API ÌïúÎèÑ</div>
      <div class="rate-providers" id="rateProviders"></div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ Ï§ëÎã®: Ï°∞ÏßÅÎèÑ + Ï±ÑÌåÖ Î°úÍ∑∏ ‚îÄ‚îÄ -->
  <div class="main-grid">
    <div class="section org-section">
      <div class="sec-header">
        <div class="sec-title">üèõÔ∏è ÌåÄ Íµ¨ÏÑ±</div>
        <div class="sec-badge">Í≥†ÏñëÏù¥ ÎßàÏùÑ Í∞úÎ∞úÌåÄ</div>
      </div>
      <div class="org" id="orgChart">
        <div class="empty"><div class="icon">‚è≥</div><div class="msg">Ïó∞Í≤∞ ÎåÄÍ∏∞ Ï§ë...</div></div>
      </div>
    </div>

    <div class="section chat-section">
      <div class="sec-header">
        <div class="sec-title">üí¨ Ï±ÑÌåÖ Î°úÍ∑∏</div>
        <div class="sec-badge" id="chatBadge">ÎåÄÌôî ÎÇ¥Ïó≠</div>
      </div>
      <div class="chat-tabs" id="chatTabs"></div>
      <div class="chat-msgs" id="chatMsgs">
        <div class="chat-empty">ÌÉ≠ÏùÑ ÏÑ†ÌÉùÌïòÎ©¥ ÎåÄÌôî ÎÇ¥Ïó≠Ïù¥ ÌëúÏãúÎê©ÎãàÎã§</div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ ÌïòÎã®: API ÏÇ¨Ïö©Îüâ + ÎπÑÏö© Ï∞®Ìä∏ (50:50) ‚îÄ‚îÄ -->
    <div class="section full">
      <div class="bottom-split">
        <div class="bottom-left">
          <div class="sec-header">
            <div class="sec-title">üìä ÏÑ∏ÏÖòÎ≥Ñ API ÏÇ¨Ïö©Îüâ</div>
            <div class="sec-badge" id="costPeriod">ÏµúÍ∑º 30Ïùº</div>
          </div>
          <div class="api-grid" id="apiGrid"></div>
        </div>
        <div class="bottom-right">
          <div class="cost-chart">
            <div class="cost-header">
              <div class="cost-title">ÏùºÎ≥Ñ ÌÜ†ÌÅ∞ ÏÇ¨Ïö©Îüâ Î∞è ÎπÑÏö©</div>
            </div>
            <div class="chart-area"><canvas class="chart-canvas" id="chartCanvas"></canvas></div>
            <div class="chart-x" id="chartX"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>

<div class="modal-bg" id="modalBg" onclick="closeModal(event)">
  <div class="modal" id="modalEl" onclick="event.stopPropagation()"></div>
</div>

<script>
// ===== CONFIG =====
const GW_HOST = location.hostname || 'localhost';
const GW_PORT = location.port || 8080; // run-amy-dashboard ÌîÑÎ°ùÏãú ÏÇ¨Ïö© Ïãú Í∞ôÏùÄ Ìè¨Ìä∏
// ~/.openclaw/openclaw.json Ïùò gateway.auth.token Í∞í (Î°úÏª¨ WebSocket Î™®ÎìúÏö©)
const GW_TOKEN = 'REPLACE_WITH_YOUR_GATEWAY_TOKEN';

// GCS Ï†ïÏ†Å Î™®Îìú: storage.googleapis.comÏù¥Î©¥ Î¨¥Ï°∞Í±¥ fetch. localhostÏóêÏÑúÎßå ?ws=1 Ïãú WebSocket
const urlParams = new URLSearchParams(location.search);
const isGcs = location.hostname === 'storage.googleapis.com' || location.hostname.endsWith('.storage.googleapis.com');
const FORCE_WS = !isGcs && (urlParams.has('ws') || urlParams.has('websocket'));
const STATIC_MODE = !FORCE_WS;
const isLocalhost = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
const GCS_BUCKET = 'openclaw-db';
// localhost: Í∞ôÏùÄ ÏÑúÎ≤ÑÏùò status.json (CORS ÏóÜÏùå). Í∑∏ Ïô∏: GCS Ï†àÎåÄÍ≤ΩÎ°ú
const STATUS_JSON_URL = urlParams.get('data') || (STATIC_MODE ? (isLocalhost ? new URL('status.json', location.href).href : `https://storage.googleapis.com/${GCS_BUCKET}/status.json`) : null);
if (STATIC_MODE) console.log('[AMY] Static mode, status URL:', STATUS_JSON_URL);

// Agent metadata (from openclaw.json + IDENTITY.md)
const META = {
  main:      { name:'Î™®Ï∞å', emoji:'üê±', role:'PM / Ï¥ùÍ¥Ñ ÎßàÏùÑ Ï¥åÏû•ÎÉ•', model:'Claude Opus 4.6', modelId:'anthropic/claude-opus-4-6', color:'#ff8844', origin:'Í≥†ÏñëÏù¥ ÎßàÏùÑ ÏãúÏ≤≠', deny:[] },
  secretary: { name:'Î£®ÎÇò', emoji:'üåô', role:'ÎπÑÏÑú / Îã¨Îπõ ÎπÑÏÑúÎÉ•', model:'GPT-5.2', modelId:'openai/gpt-5.2', color:'#c4a6ff', origin:'Í≥†ÏñëÏù¥ ÎßàÏùÑ ÏãúÏ≤≠ ÏòÜÎ∞©', deny:['browser','canvas'] },
  pm:        { name:'Î™®Ï∞å(PM)', emoji:'üê±', role:'PM(ÏÑúÎ∏å) / Ï¥åÏû• Î∂ÑÏã†ÎÉ•', model:'Claude Opus 4.6', modelId:'anthropic/claude-opus-4-6', color:'#ff8844', origin:'Í≥†ÏñëÏù¥ ÎßàÏùÑ ÏãúÏ≤≠', deny:['exec','process','write','edit','apply_patch','browser','canvas'] },
  backend:   { name:'ÍπåÎØ∏', emoji:'üêà‚Äç‚¨õ', role:'Backend / ÏßÄÌïò ÎåÄÏû•Ïû•Ïù¥ÎÉ•', model:'Claude Sonnet 4.6', modelId:'anthropic/claude-sonnet-4-6', color:'#4488ff', origin:'Í≥®Î™©Í∏∏ ÏßÄÌïò ÏûëÏóÖÏã§', deny:['browser','canvas'] },
  frontend:  { name:'ÏÜúÏù¥', emoji:'üê±', role:'Frontend / ÍΩÉÍ∞ÄÍ≤å ÎîîÏûêÏù¥ÎÑàÎÉ•', model:'Claude Sonnet 4.6', modelId:'anthropic/claude-sonnet-4-6', color:'#ff44aa', origin:'Ïñ∏Îçï ÏúÑ ÍΩÉÍ∞ÄÍ≤å', deny:['browser','canvas'] },
  devops:    { name:'ÎûëÏù¥', emoji:'üêØ', role:'DevOps / Í∞ïÍ∞Ä Î™©ÏàòÎÉ•', model:'Gemini 2.5 Flash', modelId:'google/gemini-2.5-flash', color:'#44ffaa', origin:'Í∞ïÍ∞Ä Î™©Í≥µÏÜå', deny:['browser','canvas'] },
  qa:        { name:'ÎÇòÎπÑ', emoji:'üêà', role:'QA / ÏßÄÎ∂ï ÏúÑ ÌÉêÏ†ïÎÉ•', model:'Gemini 2.5 Flash', modelId:'google/gemini-2.5-flash', color:'#f5c542', origin:'ÏßÄÎ∂ï ÏúÑ ÎßùÎ£®', deny:['write','edit','apply_patch','browser','canvas'] },
  reviewer:  { name:'Îã¨Ïù¥', emoji:'üò∫', role:'Code Reviewer / ÎèÑÏÑúÍ¥Ä ÏÇ¨ÏÑúÎÉ•', model:'Claude Opus 4.6', modelId:'anthropic/claude-opus-4-6', color:'#b07aff', origin:'ÎßàÏùÑ ÎèÑÏÑúÍ¥Ä Ï∞ΩÍ∞Ä', deny:['write','edit','apply_patch','exec','process','browser','canvas'] },
  debugger:  { name:'ÎëêÎ∂Ä', emoji:'üêæ', role:'Debugger / ÎßàÏùÑ ÏàòÏùòÏÇ¨ÎÉ•', model:'Claude Opus 4.6', modelId:'anthropic/claude-opus-4-6', color:'#ff6b6b', origin:'ÎßàÏùÑ ÏßÑÎ£åÏÜå', deny:['browser','canvas'] },
  designer:  { name:'Íµ¨Î¶Ñ', emoji:'üé®', role:'UI/UX Designer / ÎßàÏùÑ ÌôîÍ∞ÄÎÉ•', model:'Claude Sonnet 4.6', modelId:'anthropic/claude-sonnet-4-6', color:'#45b7d1', origin:'Í¥ëÏû• ÏïÑÌãÄÎ¶¨Ïóê', deny:['exec','process'] }
};

const ALL_TOOLS = ['read','write','edit','apply_patch','exec','process','browser','canvas','sessions'];

// Max Íµ¨ÎèÖÏ†ú ÌïúÎèÑ (5ÏãúÍ∞Ñ Î°§ÎßÅ ÏúàÎèÑÏö∞ Í∏∞Ï§Ä)
// Max 5x ($100/mo): ~88K tokens/5h window
// Max 20x ($200/mo): ~220K tokens/5h window
// ÏùºÏùº ÌïúÎèÑ Ï∂îÏ†ï: 5h window * ~4.8 = ~1.06M (Max 20x Í∏∞Ï§Ä)
const MAX_PLAN = {
  name: 'Max 20x',
  price: '$200/mo',
  windowTokens: 220000,       // 5ÏãúÍ∞Ñ ÏúàÎèÑÏö∞Îãπ
  windowHours: 5,
  dailyEstimate: 1056000,     // ÏùºÏùº Ï∂îÏ†ï (220K * 4.8)
  monthlyEstimate: 31680000,  // ÏõîÍ∞Ñ Ï∂îÏ†ï (ÏùºÏùº * 30)
};

// ===== STATE =====
let ws = null;
let connected = false;
let reqId = 0;
let pending = {};
let gwData = { health: null, status: null, presence: [], usage: null, cost: null, agents: null, sessions: null, rateLimitEvents: {} };
let taskMap = {}; // agentId -> { task: string, lastMsg: string, status: string }
let chatHistory = {}; // agentId -> [{ role, content, timestamp }]
let activeChatAgent = '_all';
let chatLoading = false;
let chatLastUpdated = null;
let chatError = null;

function updateChatBadge() {
  const badge = document.getElementById('chatBadge');
  if (!badge) return;
  if (chatLoading) {
    badge.textContent = 'Ï±ÑÌåÖ Î°úÎìú Ï§ë...';
    badge.title = 'chat.history RPC Ìò∏Ï∂ú Ï§ë';
  } else if (chatError) {
    badge.textContent = 'Ï±ÑÌåÖ Ïó∞Í≤∞ Ïã§Ìå®';
    badge.title = chatError;
  } else {
    const count = Object.keys(chatHistory).filter(k => (chatHistory[k]?.length || 0) > 0).length;
    const time = chatLastUpdated ? new Date(chatLastUpdated).toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', second: '2-digit' }) : '-';
    badge.textContent = count > 0 ? `Ï±ÑÌåÖ ${count}Í±¥ ¬∑ ${time}` : `ÎßàÏßÄÎßâ: ${time}`;
    badge.title = chatLastUpdated ? 'ÎßàÏßÄÎßâ Í∞±Ïã†: ' + new Date(chatLastUpdated).toLocaleString('ko-KR') : '';
  }
}

// ===== GCS Ï†ïÏ†Å Î™®Îìú (fetch) =====
async function fetchStatic() {
  if (!STATUS_JSON_URL) return;
  setConn('connecting');
  chatLoading = true;
  chatError = null;
  updateChatBadge();
  try {
    const url = STATUS_JSON_URL + (STATUS_JSON_URL.includes('?') ? '&' : '?') + 't=' + Date.now();
    const ac = new AbortController();
    const t = setTimeout(() => ac.abort(), 12000);
    const r = await fetch(url, { signal: ac.signal, cache: 'no-store' });
    clearTimeout(t);
    if (!r.ok) throw new Error(r.status + ' ' + r.statusText);
    const data = await r.json();
    gwData.health = data.health;
    gwData.status = data.status;
    gwData.presence = data.presence || [];
    gwData.usage = data.usage;
    gwData.cost = data.cost;
    gwData.sessions = data.sessions;
    gwData.rateLimitEvents = data.rateLimitEvents || {};
    // Ï†ïÏ†Å Î™®ÎìúÏóêÏÑúÎäî Ïù¥Ï†Ñ Îç∞Ïù¥ÌÑ∞ÏôÄ Î≥ëÌï©ÌïòÎ©¥ stale ÏÉÅÌÉúÍ∞Ä ÎÇ®ÏúºÎØÄÎ°ú Îß§Î≤à ÍµêÏ≤¥
    taskMap = data.taskMap || {};
    chatHistory = data.chatHistory || {};
    chatLastUpdated = data.updatedAt ? new Date(data.updatedAt).getTime() : Date.now();
    const chatCount = Object.keys(chatHistory).filter(k => (chatHistory[k]?.length || 0) > 0).length;
    console.log('[AMY] Fetch OK:', url, '| chatHistory:', chatCount, 'agents');
    connected = true;
    connError = null;
    setConn('on');
    document.getElementById('gwVersion').textContent = `GCS Ï†ïÏ†Å ¬∑ ${data.updatedAt ? new Date(data.updatedAt).toLocaleString('ko-KR') : ''}`;
    render();
    renderChatTabs();
    if (activeChatAgent === '_all') renderAllChat(); else if (activeChatAgent) renderChatMessages(activeChatAgent);
  } catch (e) {
    chatError = e.name === 'AbortError' ? 'ÏöîÏ≤≠ ÏãúÍ∞Ñ Ï¥àÍ≥º (12Ï¥à)' : (e.message || String(e));
    console.error('[AMY] Fetch failed:', chatError, '| URL:', STATUS_JSON_URL);
    setConn('off', chatError);
  } finally {
    chatLoading = false;
    updateChatBadge();
  }
}

// ===== WS CONNECTION =====
function connect() {
  if (STATIC_MODE && STATUS_JSON_URL) {
    fetchStatic();
    setInterval(fetchStatic, 5000); // Ï†ïÏ†Å Î™®ÎìúÏóêÏÑúÎèÑ Ï≤¥Í∞ê Ïã§ÏãúÍ∞Ñ(5Ï¥à Ï£ºÍ∏∞)
    return;
  }
  setConn('connecting');
  ws = new WebSocket(`ws://${GW_HOST}:${GW_PORT}`);

  ws.onopen = () => { console.log('[AMY] WebSocket opened'); };

  ws.onmessage = (e) => {
    const msg = JSON.parse(e.data);
    if (msg.type === 'event') {
      if (msg.event === 'connect.challenge') {
        sendConnect();
      } else if (msg.event === 'health') {
        fetchAll();
      } else if (msg.event === 'agent') {
        // agent session started/ended - refresh
        fetchAll();
      }
      return;
    }
    if (msg.type === 'res') {
      const cb = pending[msg.id];
      if (cb) { delete pending[msg.id]; cb(msg); }

      // After hello-ok, do initial fetch
      if (msg.id === 'connect') {
        console.log('[AMY] Connect response:', msg.ok, msg.error ? JSON.stringify(msg.error) : 'success');
      }
      if (msg.id === 'connect' && msg.ok) {
        connected = true;
        setConn('on');
        const p = msg.payload;
        document.getElementById('gwVersion').textContent = `Gateway ${p.server?.host || ''} ¬∑ ${p.server?.version || 'dev'}`;
        fetchAll();
      }
    }
  };

  ws.onclose = (ev) => { connected = false; setConn('off'); console.log('[AMY] WebSocket closed:', ev.code, ev.reason); setTimeout(connect, 3000); };
  ws.onerror = (err) => { console.error('[AMY] WebSocket error:', err); };
}

function sendConnect() {
  const frame = {
    type:'req', id:'connect', method:'connect',
    params: {
      minProtocol:3, maxProtocol:3,
      client:{ id:'openclaw-control-ui', version:'dev', platform:'web', mode:'webchat', instanceId: 'amy-dashboard-' + Date.now() },
      role:'operator', scopes:['operator.admin','operator.read','operator.approvals','operator.pairing'],
      caps: [],
      auth:{ token: GW_TOKEN },
      userAgent: navigator.userAgent,
      locale: navigator.language
    }
  };
  ws.send(JSON.stringify(frame));
}

function rpc(method, params = {}) {
  return new Promise((resolve) => {
    reqId++;
    const id = String(reqId);
    pending[id] = (msg) => resolve(msg.ok ? msg.payload : null);
    ws.send(JSON.stringify({ type:'req', id, method, params }));
  });
}

async function fetchAll() {
  if (!connected) return;
  const [health, status, presence, usage, cost, sessions] = await Promise.all([
    rpc('health'), rpc('status'), rpc('system-presence'),
    rpc('usage.status'), rpc('usage.cost'), rpc('sessions.list')
  ]);
  gwData.health = health;
  gwData.status = status;
  gwData.presence = presence;
  gwData.usage = usage;
  gwData.cost = cost;
  gwData.sessions = sessions;
  render();
  fetchTasks();
}

async function fetchTasks() {
  chatLoading = true;
  chatError = null;
  updateChatBadge();
  try {
  const byAgent = gwData.status?.sessions?.byAgent || [];
  const promises = byAgent.filter(a => a.recent?.length > 0).map(async (a) => {
    const agentId = a.agentId;
    let allSessionMsgs = [];
    // Î™®Îì† ÏµúÍ∑º ÏÑ∏ÏÖòÏóêÏÑú ÎåÄÌôî Í∞ÄÏ†∏Ïò§Í∏∞ (ÏµúÎåÄ 3Í∞ú ÏÑ∏ÏÖò)
    for (const sess of a.recent.slice(0, 3)) {
      const sessionKey = sess.key;
      try {
        const hist = await rpc('chat.history', { sessionKey, limit: 50 }).catch(() => null);
        if (!hist?.messages?.length) continue;
        const msgs = hist.messages;
        // taskMapÏùÄ Í∞ÄÏû• ÏµúÍ∑º ÏÑ∏ÏÖò Í∏∞Ï§Ä
        if (allSessionMsgs.length === 0) {
          const firstUser = msgs.find(m => m.role === 'user');
          const taskText = extractText(firstUser);
          const lastAssistant = [...msgs].reverse().find(m => m.role === 'assistant');
          const lastMsg = extractText(lastAssistant);
          const lastRole = msgs[msgs.length - 1]?.role;
          const status = lastRole === 'assistant' ? 'responded' : 'waiting';
          taskMap[agentId] = { task: truncate(taskText, 80), lastMsg: truncate(lastMsg, 120), status, sessionKey };
        }
        // Î™®Îì† ÏÑ∏ÏÖò Î©îÏãúÏßÄÎ•º Ìï©Ïπ®
        allSessionMsgs = allSessionMsgs.concat(msgs.map(m => ({
          role: m.role,
          content: extractText(m),
          timestamp: m.timestamp || null
        })).filter(m => m.content));
      } catch(e) { continue; }
    }
    if (allSessionMsgs.length > 0) {
      chatHistory[agentId] = allSessionMsgs;
    }
  });
  await Promise.all(promises);
  chatLastUpdated = Date.now();
  const chatCount = Object.keys(chatHistory).filter(k => (chatHistory[k]?.length || 0) > 0).length;
  console.log('[AMY] Chat loaded:', chatCount, 'agents');
  if (rendered) {
    renderChatTabs();
    if (activeChatAgent === '_all') {
      renderAllChat();
    } else if (activeChatAgent) {
      renderChatMessages(activeChatAgent);
    }
  }
  } catch (e) {
    chatError = e.message || String(e);
    console.error('[AMY] Chat fetch failed:', e);
  } finally {
    chatLoading = false;
    updateChatBadge();
  }
}

// ===== REAL-TIME CHAT EVENT HANDLER =====
function handleChatEvent(payload) {
  if (!payload) return;
  const sessionKey = payload.sessionKey || '';
  // Extract agentId from sessionKey (format: "agent:<agentId>:<label>" or "spawn:<agentId>:...")
  const parts = sessionKey.split(':');
  let agentId = parts.length >= 2 ? parts[1] : '';
  if (!agentId) return;

  const m = getMeta(agentId);
  if (!m || m.name === agentId && !META[agentId]) return; // unknown agent

  // Handle different chat event kinds
  const kind = payload.kind;

  if (kind === 'chunk' || kind === 'text') {
    // Streaming text - accumulate into last assistant message
    const text = payload.text || payload.content || '';
    if (!text) return;
    if (!chatHistory[agentId]) chatHistory[agentId] = [];
    const msgs = chatHistory[agentId];
    const last = msgs[msgs.length - 1];
    if (last && last.role === 'assistant' && last._streaming) {
      last.content += text;
    } else {
      msgs.push({ role: 'assistant', content: text, timestamp: Date.now(), _streaming: true });
    }
    refreshChatUI(agentId);
    return;
  }

  if (kind === 'final' || kind === 'message') {
    // Complete message
    const role = payload.role || 'assistant';
    let text = '';
    if (typeof payload.content === 'string') {
      text = payload.content;
    } else if (Array.isArray(payload.content)) {
      const tp = payload.content.find(c => c.type === 'text');
      text = tp?.text || '';
    } else if (payload.text) {
      text = payload.text;
    }
    if (!text) return;

    if (!chatHistory[agentId]) chatHistory[agentId] = [];
    const msgs = chatHistory[agentId];
    // Replace streaming message if exists
    const last = msgs[msgs.length - 1];
    if (last && last._streaming && last.role === role) {
      last.content = text;
      delete last._streaming;
    } else {
      // Ï§ëÎ≥µ Î∞©ÏßÄ: Í∞ôÏùÄ role + Í∞ôÏùÄ ÎÇ¥Ïö©Ïùò Î©îÏãúÏßÄÍ∞Ä ÎßàÏßÄÎßâÏóê Ïù¥ÎØ∏ ÏûàÏúºÎ©¥ Ïä§ÌÇµ
      const textTrim = text.slice(0, 200);
      if (last && last.role === role && last.content.slice(0, 200) === textTrim) return;
      msgs.push({ role, content: text, timestamp: Date.now() });
    }

    // Update taskMap
    if (role === 'user') {
      if (!taskMap[agentId]) taskMap[agentId] = {};
      taskMap[agentId].task = truncate(text, 80);
    } else if (role === 'assistant') {
      if (!taskMap[agentId]) taskMap[agentId] = {};
      taskMap[agentId].lastMsg = truncate(text, 120);
      taskMap[agentId].status = 'responded';
    }

    refreshChatUI(agentId);
    return;
  }

  if (kind === 'start') {
    // Session started - a user message was sent
    const text = payload.message || payload.text || '';
    if (!text) return;
    if (!chatHistory[agentId]) chatHistory[agentId] = [];
    var existMsgs = chatHistory[agentId];
    var lastExist = existMsgs[existMsgs.length - 1];
    if (!(lastExist && lastExist.role === 'user' && lastExist.content.slice(0, 200) === text.slice(0, 200))) {
      existMsgs.push({ role: 'user', content: text, timestamp: Date.now() });
    }
    if (!taskMap[agentId]) taskMap[agentId] = {};
    taskMap[agentId].task = truncate(text, 80);
    taskMap[agentId].status = 'waiting';
    refreshChatUI(agentId);
    return;
  }

  // Generic fallback: try to extract something useful
  if (payload.messages && Array.isArray(payload.messages)) {
    if (!chatHistory[agentId]) chatHistory[agentId] = [];
    payload.messages.forEach(msg => {
      const text = extractText(msg);
      if (text) {
        chatHistory[agentId].push({ role: msg.role, content: text, timestamp: Date.now() });
      }
    });
    refreshChatUI(agentId);
  }
}

function refreshChatUI(agentId) {
  if (!rendered) return;
  renderChatTabs();
  if (activeChatAgent === '_all') {
    renderAllChat();
  } else if (activeChatAgent === agentId) {
    renderChatMessages(agentId);
  }
}

function extractText(msg) {
  if (!msg) return '';
  const content = msg.content;
  let text = '';
  if (typeof content === 'string') { text = content; }
  else if (Array.isArray(content)) {
    text = content.map(c => {
      if (c.type === 'text') return c.text || '';
      if (c.type === 'tool_result' || c.type === 'tool_output') return c.output || c.content || c.text || '';
      return '';
    }).filter(Boolean).join('\n');
  } else if (content && typeof content === 'object' && (content.output || content.text)) {
    text = content.output || content.text || '';
  }
  if (typeof text !== 'string') text = '';
  // ÎîîÏä§ÏΩîÎìú Î©îÌÉÄÎç∞Ïù¥ÌÑ∞ Ï†úÍ±∞
  text = text.replace(/^System:.*?\n\n/s, '');
  text = text.replace(/Conversation info \(untrusted metadata\):\n```json\n[\s\S]*?```\n*/g, '');
  return text.trim();
}

function truncate(str, max) {
  if (!str) return '';
  const clean = str.replace(/\n/g, ' ').replace(/\s+/g, ' ').trim();
  return clean.length > max ? clean.slice(0, max) + '‚Ä¶' : clean;
}

// ===== RENDER =====
let rendered = false;

function render() {
  renderSummary();
  renderRateLimit();
  if (!rendered) {
    renderOrg();
    renderApiSection();
    renderChatTabs();
    renderAllChat();
    rendered = true;
  } else {
    patchOrg();
    patchApiSection();
  }
  renderChart();
}

function renderSummary() {
  const s = gwData.status;
  const h = gwData.health;
  const c = gwData.cost;
  const sess = gwData.sessions;

  // Sessions
  const totalSessions = (s?.sessions?.byAgent || []).reduce((sum, a) => sum + (a.count || 0), 0);
  document.getElementById('sSessionCount').textContent = totalSessions;
  const hbAgents = s?.heartbeat?.agents || [];
  const hbEnabled = hbAgents.filter(a => a.enabled).length;
  document.getElementById('sSessionSub').textContent = `ÏóêÏù¥Ï†ÑÌä∏ ${hbAgents.length}Î™Ö ¬∑ ÌôúÏÑ± ${hbEnabled}Î™Ö`;

  // Tokens / Cost
  const byAgent = s?.sessions?.byAgent || [];
  let claudeTokens = 0;
  let totalAllTokens = 0;
  byAgent.forEach(function(a) {
    (a.recent || []).forEach(function(r) {
      const model = (r.model || '').toLowerCase();
      const tokens = r.totalTokens || 0;
      totalAllTokens += tokens;
      if (model.includes('claude') || model.includes('opus') || model.includes('sonnet') || model.includes('haiku')) {
        claudeTokens += tokens;
      }
    });
  });

  const totals = c?.totals;
  const claudeRatio = totalAllTokens > 0 ? claudeTokens / totalAllTokens : 1;
  const claudeCost = totals ? totals.totalCost * claudeRatio : 0;

  const usedTokens = claudeTokens;
  const monthlyLimit = MAX_PLAN.monthlyEstimate;
  const quotaPct = Math.min((usedTokens / monthlyLimit) * 100, 100);
  const quotaColor = quotaPct >= 90 ? 'var(--red)' : quotaPct >= 70 ? 'var(--orange)' : quotaPct >= 40 ? 'var(--yellow)' : 'var(--green)';

  document.getElementById('sTokens').textContent = fmtTokens(usedTokens) + ' / ' + fmtTokens(monthlyLimit);
  document.getElementById('sTokenCost').textContent = usedTokens > 0
    ? `~$${claudeCost.toFixed(2)} ¬∑ Claude (${c?.days || 30}ÏùºÍ∞Ñ)`
    : 'Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå';

  const qFill = document.getElementById('sQuotaFill');
  const qUsed = document.getElementById('sQuotaUsed');
  const qLimit = document.getElementById('sQuotaLimit');
  if (qFill) { qFill.style.width = quotaPct.toFixed(1) + '%'; qFill.style.background = quotaColor; }
  if (qUsed) qUsed.textContent = quotaPct.toFixed(1) + '% ÏÇ¨Ïö©';
  if (qLimit) qLimit.textContent = MAX_PLAN.name + ' (' + MAX_PLAN.price + ')';

  // Channel
  const discord = h?.channels?.discord;
  if (discord) {
    const probe = discord.probe;
    document.getElementById('sChannel').textContent = probe?.ok ? 'Discord ‚úì' : 'Discord ‚úó';
    document.getElementById('sChannel').style.color = probe?.ok ? 'var(--green)' : 'var(--red)';
    document.getElementById('sChannelSub').textContent = probe?.bot ? `@${probe.bot.username}` : (discord.running ? 'Ïã§Ìñâ Ï§ë' : 'ÎåÄÍ∏∞ Ï§ë');
  }
}

// ===== RATE LIMIT BANNER =====
function renderRateLimit() {
  const usage = gwData.usage;
  const rle = gwData.rateLimitEvents || {};
  const bar = document.getElementById('rateLimitBar');
  const container = document.getElementById('rateProviders');
  if (!bar || !container) return;

  const now = Date.now();

  function fmtCountdown(resetAt) {
    if (!resetAt) return '';
    const diff = resetAt - now;
    if (diff <= 0) return '‚úÖ Î¶¨ÏÖãÎê®';
    const h = Math.floor(diff / 3600000);
    const m = Math.floor((diff % 3600000) / 60000);
    const s = Math.floor((diff % 60000) / 1000);
    if (h > 0) return `${h}h ${m}m ${s}s ÌõÑ Î¶¨ÏÖã`;
    if (m > 0) return `${m}m ${s}s ÌõÑ Î¶¨ÏÖã`;
    return `${s}s ÌõÑ Î¶¨ÏÖã`;
  }

  function fmtAgo(ts) {
    if (!ts) return '';
    const diff = now - ts;
    const h = Math.floor(diff / 3600000);
    const m = Math.floor((diff % 3600000) / 60000);
    if (h > 0) return `${h}h ${m}m Ï†Ñ Î∞úÏÉù`;
    if (m > 0) return `${m}m Ï†Ñ Î∞úÏÉù`;
    return 'Î∞©Í∏à Î∞úÏÉù';
  }

  // ‚îÄ‚îÄ 1. Claude (Anthropic) Ïπ¥Îìú ‚îÄ‚îÄ
  // API ÏÇ¨Ïö©Îüâ Ï∞Ω(windows)ÏùÄ 403 Ïò§Î•òÎ°ú Ï°∞Ìöå Î∂àÍ∞Ä ‚Üí Î°úÍ∑∏ Í∏∞Î∞ò rle.anthropic ÏÇ¨Ïö©
  const ant = rle.anthropic;
  let claudeHtml = '';
  if (ant) {
    const inCD = ant.inCooldown && ant.estimatedResetAt > now;
    const countdown = fmtCountdown(ant.estimatedResetAt);
    const ago = fmtAgo(ant.lastAt);
    if (inCD) {
      claudeHtml = `<div class="rl-card rl-danger">
        <div class="rl-card-header">
          <span class="rl-icon">üü£</span>
          <span class="rl-name">Claude</span>
          <span class="rl-provider">Anthropic ¬∑ 5ÏãúÍ∞Ñ Î°§ÎßÅ</span>
        </div>
        <div class="rl-status-row">
          <span class="rl-badge-danger">‚õî Ïø®Îã§Ïö¥</span>
          <span class="rl-countdown danger">${countdown}</span>
        </div>
        <div class="rl-sub">${ago}</div>
      </div>`;
    } else {
      // Ïø®Îã§Ïö¥ÏùÄ Ìï¥Ï†úÎêêÏßÄÎßå Ïù¥Ï†Ñ Í∏∞Î°ù Ï°¥Ïû¨
      claudeHtml = `<div class="rl-card rl-ok">
        <div class="rl-card-header">
          <span class="rl-icon">üü£</span>
          <span class="rl-name">Claude</span>
          <span class="rl-provider">Anthropic ¬∑ 5ÏãúÍ∞Ñ Î°§ÎßÅ</span>
        </div>
        <div class="rl-status-row">
          <span class="rl-badge-ok">‚úÖ Ï†ïÏÉÅ</span>
          <span class="rl-countdown ok">${ant.estimatedResetAt > 0 ? fmtCountdown(ant.estimatedResetAt) : ''}</span>
        </div>
        <div class="rl-sub">${ago}</div>
      </div>`;
    }
  } else {
    claudeHtml = `<div class="rl-card rl-ok">
      <div class="rl-card-header">
        <span class="rl-icon">üü£</span>
        <span class="rl-name">Claude</span>
        <span class="rl-provider">Anthropic ¬∑ 5ÏãúÍ∞Ñ Î°§ÎßÅ</span>
      </div>
      <div class="rl-status-row">
        <span class="rl-badge-ok">‚úÖ Ï†ïÏÉÅ</span>
      </div>
      <div class="rl-sub">Ï†úÌïú Í∏∞Î°ù ÏóÜÏùå</div>
    </div>`;
  }

  // ‚îÄ‚îÄ 2. Codex (OpenAI) Ïπ¥Îìú ‚îÄ‚îÄ
  const codexProvider = (usage?.providers || []).find(p => p.provider === 'openai-codex');
  let codexHtml = '';
  if (codexProvider) {
    const wins = codexProvider.windows || [];
    const win5h = wins.find(w => w.label === '5h') || wins[0];
    const winDay = wins.find(w => w.label === 'Day');
    const pct = Math.min(win5h?.usedPercent || 0, 100);
    const pctDay = Math.min(winDay?.usedPercent || 0, 100);
    const cls = pct >= 90 ? 'rl-danger' : pct >= 70 ? 'rl-warn' : 'rl-ok';
    const barColor = pct >= 90 ? 'var(--red)' : pct >= 70 ? 'var(--orange)' : pct >= 40 ? 'var(--yellow)' : 'var(--green)';
    const pctColor = pct >= 90 ? 'var(--red)' : pct >= 70 ? 'var(--orange)' : pct >= 40 ? 'var(--yellow)' : 'var(--green)';
    const countdown5h = win5h?.resetAt ? fmtCountdown(win5h.resetAt) : '';
    codexHtml = `<div class="rl-card ${cls}">
      <div class="rl-card-header">
        <span class="rl-icon">üü¢</span>
        <span class="rl-name">Codex</span>
        <span class="rl-provider">OpenAI ¬∑ 5h / Day</span>
      </div>
      <div class="rl-bar-row">
        <span class="rl-win-label">5h</span>
        <div class="rl-bar"><div class="rl-bar-fill" style="width:${pct}%;background:${barColor};"></div></div>
        <span class="rl-pct" style="color:${pctColor};">${pct}%</span>
      </div>
      ${winDay ? `<div class="rl-bar-row">
        <span class="rl-win-label">Day</span>
        <div class="rl-bar"><div class="rl-bar-fill" style="width:${pctDay}%;background:${pctDay>=90?'var(--red)':pctDay>=70?'var(--orange)':'var(--green)'};"></div></div>
        <span class="rl-pct">${pctDay}%</span>
      </div>` : ''}
      ${countdown5h ? `<div class="rl-sub">${countdown5h}</div>` : ''}
    </div>`;
  }

  // ‚îÄ‚îÄ 3. Gemini (Google) Ïπ¥Îìú ‚îÄ‚îÄ
  const goo = rle.google;
  let geminiHtml = '';
  if (goo) {
    const inCD = goo.inCooldown && goo.estimatedResetAt > now;
    const countdown = fmtCountdown(goo.estimatedResetAt);
    const ago = fmtAgo(goo.lastAt);
    if (inCD) {
      geminiHtml = `<div class="rl-card rl-danger">
        <div class="rl-card-header">
          <span class="rl-icon">üîµ</span>
          <span class="rl-name">Gemini</span>
          <span class="rl-provider">Google ¬∑ ~1h Ï∞Ω</span>
        </div>
        <div class="rl-status-row">
          <span class="rl-badge-danger">‚õî Í≥ºÎ∂ÄÌïò</span>
          <span class="rl-countdown danger">${countdown}</span>
        </div>
        <div class="rl-sub">${ago}</div>
      </div>`;
    } else {
      geminiHtml = `<div class="rl-card rl-ok">
        <div class="rl-card-header">
          <span class="rl-icon">üîµ</span>
          <span class="rl-name">Gemini</span>
          <span class="rl-provider">Google ¬∑ ~1h Ï∞Ω</span>
        </div>
        <div class="rl-status-row">
          <span class="rl-badge-ok">‚úÖ Ï†ïÏÉÅ</span>
        </div>
        <div class="rl-sub">${ago}</div>
      </div>`;
    }
  }

  bar.style.display = 'flex';
  const anyData = claudeHtml || codexHtml || geminiHtml;
  if (!anyData) {
    container.innerHTML = `<div class="rl-card rl-ok" style="flex:1;">
      <div class="rl-card-header"><span class="rl-icon">‚úÖ</span><span class="rl-name" style="color:var(--green);">Î™®Îì† API Ï†ïÏÉÅ</span></div>
      <div class="rl-sub">Ïø®Îã§Ïö¥ ÏóÜÏùå ¬∑ Claude / Codex / Gemini</div>
    </div>`;
    return;
  }
  container.innerHTML = claudeHtml + codexHtml + geminiHtml;
}

function renderOrg() {
  const chart = document.getElementById('orgChart');
  const fixedOrder = ['main','secretary','backend','frontend','devops','qa','reviewer','debugger','designer'];
  const hbIds = new Set((gwData.status?.heartbeat?.agents || []).map(a => a.agentId));
  const agentIds = fixedOrder.filter(id => id === 'main' || hbIds.has(id));
  if (agentIds.length === 0) { chart.innerHTML = '<div class="empty"><div class="icon">üì≠</div><div class="msg">Îì±Î°ùÎêú ÏóêÏù¥Ï†ÑÌä∏Í∞Ä ÏóÜÏäµÎãàÎã§</div></div>'; return; }

  const sessionMap = buildSessionMap();
  const has = (id) => agentIds.includes(id);

  function node(id, extraClass) {
    const m = getMeta(id);
    const on = !!sessionMap[id];
    return `<div class="org-node ${extraClass||''}" data-org="${id}" style="--c:${m.color}" onclick="openModal('${id}')">
      <div class="ind" data-org-ind="${id}" style="background:${on ? 'var(--green)' : 'var(--text-3)'};box-shadow:0 0 6px ${on ? 'var(--green)' : 'transparent'};"></div>
      <div class="org-emoji">${m.emoji}</div>
      <div class="org-name">${m.name}</div>
      <div class="org-role">${m.role.split('/')[0].trim()}</div>
      <div class="org-model">${m.model}</div>
    </div>`;
  }

  // ÏàòÏû• Î™®Ï∞å Í∞ÄÏö¥Îç∞, Î£®ÎÇò(ÎπÑÏÑú) Î™®Ï∞å Ïò§Î•∏Ï™Ω
  const topRow = `<div class="org-top-row">
    <div></div>
    <div class="org-boss-center">${node('main', 'boss-node')}</div>
    <div class="org-boss-right">${has('secretary') ? node('secretary', '') : ''}</div>
  </div>`;

  // Î™®Ï∞å ÏïÑÎûò: Í∞úÎ∞úÌåÄÎßå (ÍπåÎØ∏‚ÜíÎã¨Ïù¥, ÏÜúÏù¥‚ÜíÎëêÎ∂Ä, ÎûëÏù¥, ÎÇòÎπÑ‚ÜíÍµ¨Î¶Ñ)
  const cols = [
    has('backend') ? { parent: 'backend', child: has('reviewer') ? 'reviewer' : null } : null,
    has('frontend') ? { parent: 'frontend', child: has('debugger') ? 'debugger' : null } : null,
    has('devops') ? { parent: 'devops', child: null } : null,
    has('qa') ? { parent: 'qa', child: has('designer') ? 'designer' : null } : null
  ].filter(Boolean);

  if (cols.length === 0) {
    chart.innerHTML = topRow;
    return;
  }

  const colHtml = cols.map(c => `
    <div class="team-col">
      <div class="vline-sm"></div>
      ${node(c.parent)}
      ${c.child ? `<div class="vline-sm"></div>${node(c.child)}` : ''}
    </div>
  `).join('');

  const hlineW = Math.min(cols.length * 170, 600);

  chart.innerHTML = `${topRow}
    <div class="vline"></div>
    <div class="hline" style="width:${hlineW}px;"></div>
    <div class="org-rows">
      <div class="team-row">${colHtml}</div>
    </div>`;
}

function renderApiSection() {
  const grid = document.getElementById('apiGrid');
  const byAgent = gwData.status?.sessions?.byAgent || [];
  const fixedOrder = ['main','secretary','backend','frontend','devops','qa','reviewer','debugger','designer'];

  if (byAgent.length === 0) {
    grid.innerHTML = '<div class="empty" style="grid-column:1/-1;"><div class="icon">üì≠</div><div class="msg">ÏÑ∏ÏÖò ÏÇ¨Ïö© Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§</div></div>';
    return;
  }

  function buildAgentCard(id) {
    const m = getMeta(id);
    const agentSessions = byAgent.find(a => a.agentId === id);
    const recent = agentSessions?.recent || [];
    const sessionUpdatedMs = (s) => {
      const raw = s?.updatedAt ?? s?.lastMessageAt ?? s?.lastActivityAt ?? s?.createdAt ?? 0;
      if (typeof raw === 'number') return raw;
      const ts = Date.parse(raw || '');
      return Number.isFinite(ts) ? ts : 0;
    };
    const sortedRecent = [...recent].sort((a, b) => sessionUpdatedMs(b) - sessionUpdatedMs(a));
    const latest = sortedRecent[0] || null;
    const latestUpdatedMs = sessionUpdatedMs(latest);
    const latestUpdatedLabel = latestUpdatedMs
      ? new Date(latestUpdatedMs).toLocaleString('ko-KR', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' })
      : '-';
    const latestPctRaw = latest?.percentUsed;
    const latestPct = typeof latestPctRaw === 'number'
      ? latestPctRaw
      : ((latest?.contextTokens || 0) > 0 ? ((latest?.totalTokens || 0) / latest.contextTokens * 100) : 0);
    const latestCls = latestPct >= 90 ? 'crit' : latestPct >= 70 ? 'high' : latestPct >= 40 ? 'mid' : 'low';
    const sessionsHtml = sortedRecent.length === 0
      ? `<div class="api-row"><span class="l">ÏµúÍ∑º ÏÑ∏ÏÖò</span><span class="v">ÏóÜÏùå</span></div>`
      : sortedRecent.slice(0, 3).map((s, idx) => {
          const pctRaw = s?.percentUsed;
          const pct = typeof pctRaw === 'number'
            ? pctRaw
            : ((s?.contextTokens || 0) > 0 ? ((s?.totalTokens || 0) / s.contextTokens * 100) : 0);
          const cls = pct >= 90 ? 'crit' : pct >= 70 ? 'high' : pct >= 40 ? 'mid' : 'low';
          const updatedMs = sessionUpdatedMs(s);
          const updatedLabel = updatedMs
            ? new Date(updatedMs).toLocaleString('ko-KR', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' })
            : '-';
          const label = truncate(s.displayName || s.key || `session-${idx + 1}`, 18);
          return `
            <div class="api-row"><span class="l">#${idx + 1} ${escapeHtml(label)}</span><span class="v">${pct.toFixed(0)}%</span></div>
            <div class="ubar"><div class="ufill ${cls}" style="width:${Math.min(pct, 100)}%;"></div></div>
            <div style="font-size:10px;color:var(--text-3);text-align:right;margin-bottom:4px;">${fmtTokens(s.totalTokens || 0)} / ${fmtTokens(s.contextTokens || 0)}</div>
            <div style="font-size:10px;color:var(--text-3);text-align:right;margin-bottom:4px;">ÎßàÏßÄÎßâ ÏÇ¨Ïö©: ${updatedLabel}</div>
          `;
        }).join('');

    return `<div class="api-card" data-api="${id}" style="--c:${m.color};">
      <div class="emoji">${m.emoji}</div>
      <div class="name">${m.name}</div>
      <div class="model">${m.model}</div>
      <div class="ubar"><div class="ufill ${latestCls}" style="width:${Math.min(latestPct, 100)}%;"></div></div>
      <div class="upct" style="color:${latestPct >= 70 ? 'var(--orange)' : 'var(--text-2)'};">${latestPct.toFixed(1)}% ÏµúÍ∑º ÏÑ∏ÏÖò</div>
      <div class="card-body">
        <div class="api-row"><span class="l">ÏÑ∏ÏÖò Ïàò</span><span class="v">${sortedRecent.length}</span></div>
        <div class="api-row"><span class="l">ÏµúÍ∑º ÏÇ¨Ïö©</span><span class="v">${latestUpdatedLabel}</span></div>
        ${sessionsHtml}
      </div>
    </div>`;
  }

  grid.innerHTML = fixedOrder.map(buildAgentCard).join('');
}

// ===== PATCH (no-flicker update) =====
function patchOrg() {
  const sessionMap = buildSessionMap();
  const allIds = ['pm','backend','frontend','devops','qa','reviewer'];
  allIds.forEach(id => {
    const ind = document.querySelector(`[data-org-ind="${id}"]`);
    if (ind) {
      const on = !!sessionMap[id];
      ind.style.background = on ? 'var(--green)' : 'var(--text-3)';
      ind.style.boxShadow = on ? '0 0 6px var(--green)' : 'none';
    }
  });
}

function patchApiSection() {
  // ÏÑ∏ÏÖòÎ≥Ñ ÏÇ¨Ïö©Îüâ Ïπ¥ÎìúÎäî Ìï≠Î™© Íµ¨Ï°∞Í∞Ä ÏûêÏ£º Î∞îÎÄåÎØÄÎ°ú Ï†ÑÏ≤¥ Ïû¨Î†åÎçî
  renderApiSection();
}

function renderChatTabs() {
  const tabs = document.getElementById('chatTabs');
  const fixedOrder = ['main','secretary','backend','frontend','devops','qa','reviewer','debugger','designer'];
  const hbIds = new Set((gwData.status?.heartbeat?.agents || []).map(a => a.agentId));
  const agentIds = fixedOrder.filter(id => hbIds.has(id));

  const allActive = activeChatAgent === '_all';
  let html = `<div class="chat-tab ${allActive ? 'active' : ''}" data-chat-tab="_all">
    <span class="tab-dot" style="background:var(--accent);"></span>üåê Ï†ÑÏ≤¥
  </div>`;
  html += agentIds.map(id => {
    const m = getMeta(id);
    const hasMsgs = chatHistory[id]?.length > 0;
    const isActive = activeChatAgent === id;
    return `<div class="chat-tab ${isActive ? 'active' : ''}" data-chat-tab="${id}">
      <span class="tab-dot" style="background:${hasMsgs ? m.color : 'var(--text-3)'};"></span>${m.emoji} ${m.name}
    </div>`;
  }).join('');
  tabs.innerHTML = html;
}

// Ïù¥Î≤§Ìä∏ ÏúÑÏûÑÏúºÎ°ú ÌÉ≠ ÌÅ¥Î¶≠ Ï≤òÎ¶¨ (debugger ÏòàÏïΩÏñ¥ Ï∂©Îèå Î∞©ÏßÄ)
document.addEventListener('click', function(e) {
  var tab = e.target.closest('[data-chat-tab]');
  if (!tab) return;
  e.preventDefault();
  e.stopPropagation();
  var agentId = tab.getAttribute('data-chat-tab');
  if (!agentId) return;
  activeChatAgent = agentId;
  // Î™®Îì† ÌÉ≠Ïùò active ÌÅ¥ÎûòÏä§ Ï¶âÏãú ÌÜ†Í∏Ä
  document.querySelectorAll('.chat-tab').forEach(function(t) {
    t.classList.toggle('active', t.getAttribute('data-chat-tab') === agentId);
  });
  if (agentId === '_all') {
    renderAllChat();
  } else {
    renderChatMessages(agentId);
  }
}, true);

function isScrolledToBottom(el) {
  return el.scrollHeight - el.scrollTop - el.clientHeight < 60;
}

function renderChatMessages(agentId) {
  const container = document.getElementById('chatMsgs');
  const wasAtBottom = isScrolledToBottom(container);
  const msgs = chatHistory[agentId];
  const m = getMeta(agentId);

  if (!msgs || msgs.length === 0) {
    let emptyMsg = `üì≠ ${m.name}Ïùò ÎåÄÌôî Í∏∞Î°ùÏù¥ ÏóÜÏäµÎãàÎã§`;
    if (chatError) emptyMsg += `<br><span style="font-size:11px;color:var(--red);">‚ö† ${chatError}</span>`;
    else if (chatLoading) emptyMsg = '‚è≥ Ï±ÑÌåÖ Î°úÎìú Ï§ë...';
    container.innerHTML = `<div class="chat-empty">${emptyMsg}</div>`;
    return;
  }

  container.innerHTML = msgs.filter(msg => ['user','assistant','tool','toolResult'].includes(msg.role)).map(msg => {
    const isUser = msg.role === 'user';
    const isTool = msg.role === 'tool' || msg.role === 'toolResult';
    const isSpawn = !isUser && !isTool && msg.content.includes('sessions_spawn');
    const roleLabel = isUser ? 'üë§ ÏßÄÏãú' : (isTool ? 'üñ•Ô∏è ÌÑ∞ÎØ∏ÎÑê' : `${m.emoji} ${m.name}`);
    const roleColor = isUser ? 'var(--accent)' : (isTool ? 'var(--green)' : m.color);
    const text = msg.content.length > 800 ? msg.content.slice(0, 800) + '‚Ä¶' : msg.content;
    const time = msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString('ko-KR', { hour:'2-digit', minute:'2-digit' }) : '';
    const msgClass = isSpawn ? 'spawn' : msg.role;
    return `<div class="chat-msg ${msgClass}">
      <div class="cm-ava">${isUser ? 'üë§' : (isTool ? 'üñ•Ô∏è' : m.emoji)}</div>
      <div class="cm-body">
        <div class="cm-head">
          <div class="cm-role" style="color:${roleColor};">${roleLabel}</div>
          <div class="cm-agent-tag" style="background:${m.color}20;color:${m.color};">${m.role.split('/')[0].trim()}</div>
          ${isSpawn ? '<span class="chat-arrow">‚Üí ÏúÑÏûÑ</span>' : ''}
        </div>
        <div class="cm-text">${escapeHtml(text)}</div>
      </div>
      ${time ? `<div class="cm-time">${time}</div>` : ''}
    </div>`;
  }).join('');

  if (wasAtBottom) container.scrollTop = container.scrollHeight;
}

function renderAllChat() {
  const container = document.getElementById('chatMsgs');
  const wasAtBottom = isScrolledToBottom(container);

  // Î™®Îì† ÏóêÏù¥Ï†ÑÌä∏ ÎåÄÌôîÎ•º Ìï©ÏπòÍ≥† ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ ÎòêÎäî ÏàúÏÑúÎ°ú Ï†ïÎ†¨
  const allMsgs = [];
  const fixedOrder = ['main','secretary','backend','frontend','devops','qa','reviewer','debugger','designer'];

  fixedOrder.forEach(agentId => {
    const msgs = chatHistory[agentId];
    if (!msgs || msgs.length === 0) return;
    msgs.filter(msg => ['user','assistant','tool','toolResult'].includes(msg.role)).forEach((msg, idx) => {
      allMsgs.push({
        ...msg,
        agentId,
        sortKey: msg.timestamp ? new Date(msg.timestamp).getTime() : (fixedOrder.indexOf(agentId) * 10000 + idx)
      });
    });
  });

  if (allMsgs.length === 0) {
    let emptyMsg = 'üì≠ ÏïÑÏßÅ ÎåÄÌôî Í∏∞Î°ùÏù¥ ÏóÜÏäµÎãàÎã§';
    if (chatError) emptyMsg += `<br><span style="font-size:11px;color:var(--red);">‚ö† ${chatError}</span>`;
    else if (chatLoading) emptyMsg = '‚è≥ Ï±ÑÌåÖ Î°úÎìú Ï§ë...';
    container.innerHTML = `<div class="chat-empty">${emptyMsg}</div>`;
    return;
  }

  allMsgs.sort((a, b) => a.sortKey - b.sortKey);

  let lastAgent = null;
  let html = '';

  allMsgs.forEach(msg => {
    const m = getMeta(msg.agentId);
    const isUser = msg.role === 'user';
    const isTool = msg.role === 'tool' || msg.role === 'toolResult';
    const isSpawn = !isUser && !isTool && msg.content.includes('sessions_spawn');

    // ÏóêÏù¥Ï†ÑÌä∏Í∞Ä Î∞îÎÄåÎ©¥ Íµ¨Î∂ÑÏÑ†
    if (msg.agentId !== lastAgent) {
      html += `<div class="chat-divider">${m.emoji} ${m.name} ÎåÄÌôî</div>`;
      lastAgent = msg.agentId;
    }

    const roleLabel = isUser ? `üë§ ‚Üí ${m.emoji} ${m.name}` : (isTool ? `üñ•Ô∏è ÌÑ∞ÎØ∏ÎÑê` : `${m.emoji} ${m.name}`);
    const roleColor = isUser ? 'var(--accent)' : (isTool ? 'var(--green)' : m.color);
    const text = msg.content.length > 600 ? msg.content.slice(0, 600) + '‚Ä¶' : msg.content;
    const time = msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString('ko-KR', { hour:'2-digit', minute:'2-digit' }) : '';
    const msgClass = isSpawn ? 'spawn' : msg.role;

    // spawn Í∞êÏßÄ: Ïñ¥Îñ§ ÏóêÏù¥Ï†ÑÌä∏ÏóêÍ≤å ÏúÑÏûÑÌñàÎäîÏßÄ ÌååÏã±
    let spawnInfo = '';
    if (isSpawn) {
      const agentMatch = msg.content.match(/agentId[:\s]*["']?(\w+)["']?/);
      if (agentMatch) {
        const targetM = getMeta(agentMatch[1]);
        spawnInfo = `<span class="chat-arrow">‚Üí ${targetM.emoji} ${targetM.name}ÏóêÍ≤å ÏúÑÏûÑ</span>`;
      } else {
        spawnInfo = '<span class="chat-arrow">‚Üí ÏúÑÏûÑ</span>';
      }
    }

    html += `<div class="chat-msg ${msgClass}">
      <div class="cm-ava">${isUser ? 'üë§' : (isTool ? 'üñ•Ô∏è' : m.emoji)}</div>
      <div class="cm-body">
        <div class="cm-head">
          <div class="cm-role" style="color:${roleColor};">${roleLabel}</div>
          <div class="cm-agent-tag" style="background:${m.color}20;color:${m.color};">${m.role.split('/')[0].trim()}</div>
          ${spawnInfo}
        </div>
        <div class="cm-text">${escapeHtml(text)}</div>
      </div>
      ${time ? `<div class="cm-time">${time}</div>` : ''}
    </div>`;
  });

  container.innerHTML = html;
  if (wasAtBottom) container.scrollTop = container.scrollHeight;
}

function escapeHtml(str) {
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function renderChart() {
  const canvas = document.getElementById('chartCanvas');
  const ctx = canvas.getContext('2d');
  const daily = gwData.cost?.daily || [];
  if (daily.length === 0) return;

  const dpr = window.devicePixelRatio || 1;
  const rect = canvas.parentElement.getBoundingClientRect();
  canvas.width = rect.width * dpr;
  canvas.height = rect.height * dpr;
  canvas.style.width = rect.width + 'px';
  canvas.style.height = rect.height + 'px';
  ctx.scale(dpr, dpr);
  const W = rect.width, H = rect.height;
  const pL = 50, pR = 10, pT = 10, pB = 5;

  ctx.clearRect(0, 0, W, H);

  const maxTokens = Math.max(1, ...daily.map(d => d.totalTokens));
  const maxCost = Math.max(0.001, ...daily.map(d => d.totalCost));

  // Grid
  ctx.strokeStyle = 'rgba(42,51,69,.5)';
  ctx.lineWidth = 1;
  ctx.font = '10px JetBrains Mono';
  ctx.fillStyle = '#5a6478';
  for (let i = 0; i <= 4; i++) {
    const y = pT + (H - pT - pB) * (1 - i / 4);
    ctx.beginPath(); ctx.moveTo(pL, y); ctx.lineTo(W - pR, y); ctx.stroke();
    ctx.fillText(fmtTokens(Math.round(maxTokens * i / 4)), 2, y + 3);
  }

  // Bars for tokens
  const barW = Math.max(4, (W - pL - pR) / daily.length - 2);
  daily.forEach((d, i) => {
    const x = pL + (W - pL - pR) * (i / daily.length);
    const h = (d.totalTokens / maxTokens) * (H - pT - pB);
    ctx.fillStyle = 'rgba(108,140,255,.4)';
    ctx.fillRect(x, H - pB - h, barW, h);
    // Cost line dot
    const costY = pT + (H - pT - pB) * (1 - d.totalCost / maxCost);
    ctx.beginPath();
    ctx.arc(x + barW / 2, costY, 3, 0, Math.PI * 2);
    ctx.fillStyle = '#f5c542';
    ctx.fill();
  });

  // Cost line
  ctx.beginPath();
  ctx.strokeStyle = '#f5c542';
  ctx.lineWidth = 2;
  daily.forEach((d, i) => {
    const x = pL + (W - pL - pR) * (i / daily.length) + barW / 2;
    const y = pT + (H - pT - pB) * (1 - d.totalCost / maxCost);
    if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
  });
  ctx.stroke();

  // X axis
  const xEl = document.getElementById('chartX');
  const step = Math.max(1, Math.floor(daily.length / 8));
  xEl.innerHTML = daily.filter((_, i) => i % step === 0).map(d => `<span>${d.date.slice(5)}</span>`).join('');
}

// ===== MODAL =====
function openModal(id) {
  const m = getMeta(id);
  const byAgent = gwData.status?.sessions?.byAgent || [];
  const agentSessions = byAgent.find(a => a.agentId === id);
  const recent = agentSessions?.recent || [];
  const totalTokens = recent.reduce((s, r) => s + (r.totalTokens || 0), 0);
  const inputTokens = recent.reduce((s, r) => s + (r.inputTokens || 0), 0);
  const outputTokens = recent.reduce((s, r) => s + (r.outputTokens || 0), 0);
  const pctUsed = recent[0]?.percentUsed || 0;
  const model = recent[0]?.model || m.modelId;
  const hbAgent = (gwData.status?.heartbeat?.agents || []).find(a => a.agentId === id);

  document.getElementById('modalEl').innerHTML = `
    <div class="m-top">
      <div class="m-ava" style="border-color:${m.color}40;">${m.emoji}</div>
      <div class="m-info">
        <div class="m-name">${m.name} <span class="tag ${recent.length ? 'on' : 'off'}" style="font-size:11px;">${recent.length ? 'ÏÑ∏ÏÖò ÌôúÏÑ±' : 'ÏÑ∏ÏÖò ÏóÜÏùå'}</span></div>
        <div class="m-role">${m.role}</div>
        <div class="m-model"><span style="color:${m.color};">‚óè</span> ${m.model} <span style="margin-left:8px;">üè† ${m.origin}</span></div>
      </div>
      <button class="m-close" onclick="closeModal()">‚úï</button>
    </div>
    <div class="m-body">
      ${taskMap[id]?.task ? `<div class="m-sec">
        <div class="m-sec-t">üìã ÌòÑÏû¨ ÏûëÏóÖ</div>
        <div style="background:var(--bg-2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:12px 16px;">
          <div style="font-size:13px;font-weight:600;color:var(--text-0);margin-bottom:6px;">${taskMap[id].task}</div>
          ${taskMap[id].lastMsg ? `<div style="font-size:12px;color:var(--text-2);line-height:1.4;">‚Ü≥ ${taskMap[id].lastMsg}</div>` : ''}
          <div style="font-size:10px;color:var(--text-3);margin-top:6px;">ÏÉÅÌÉú: ${taskMap[id].status === 'responded' ? '‚úÖ ÏùëÎãµ ÏôÑÎ£å' : '‚è≥ ÎåÄÍ∏∞ Ï§ë'}</div>
        </div>
      </div>` : ''}
      <div class="m-sec">
        <div class="m-sec-t">‚öôÔ∏è ÌïòÌä∏ÎπÑÌä∏</div>
        <div style="background:var(--bg-2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:12px 16px;font-size:13px;">
          ${hbAgent?.enabled
            ? `ÌôúÏÑ± ¬∑ Ï£ºÍ∏∞: ${hbAgent.every}`
            : `<span style="color:var(--text-3);">ÎπÑÌôúÏÑ± (ÌïòÌä∏ÎπÑÌä∏ Í∫ºÏßê)</span>`}
        </div>
      </div>
      <div class="m-sec">
        <div class="m-sec-t">üí¨ ÏÑ∏ÏÖò Ï†ïÎ≥¥</div>
        ${recent.length > 0
          ? recent.map(s => `
            <div style="background:var(--bg-2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:12px 16px;margin-bottom:8px;">
              <div style="font-size:13px;font-weight:600;margin-bottom:4px;">${s.displayName || s.key}</div>
              <div style="font-size:11px;color:var(--text-2);">Î™®Îç∏: ${s.model || model} ¬∑ Ïª®ÌÖçÏä§Ìä∏: ${fmtTokens(s.contextTokens || 0)}</div>
              <div style="display:flex;align-items:center;gap:10px;margin-top:8px;">
                <div style="flex:1;height:6px;background:var(--bg-0);border-radius:3px;overflow:hidden;">
                  <div style="height:100%;width:${s.percentUsed || 0}%;background:${(s.percentUsed||0) > 70 ? 'var(--red)' : 'var(--green)'};border-radius:3px;"></div>
                </div>
                <span style="font-size:12px;font-weight:600;font-family:'JetBrains Mono',monospace;">${s.percentUsed || 0}%</span>
              </div>
            </div>
          `).join('')
          : '<div style="color:var(--text-3);font-size:13px;">ÌôúÏÑ± ÏÑ∏ÏÖò ÏóÜÏùå</div>'}
      </div>
      <div class="m-sec">
        <div class="m-sec-t">üîë ÎèÑÍµ¨ Í∂åÌïú</div>
        <div class="chip-grid">
          ${ALL_TOOLS.map(t => {
            const denied = m.deny.includes(t);
            return `<div class="chip ${denied ? 'no' : 'ok'}">${denied ? '‚úó' : '‚úì'} ${t}</div>`;
          }).join('')}
        </div>
      </div>
      <div class="m-sec">
        <div class="m-sec-t">üìä ÌÜ†ÌÅ∞ ÏÇ¨Ïö©Îüâ</div>
        <div class="mini-grid">
          <div class="mini"><div class="l">ÏûÖÎ†• ÌÜ†ÌÅ∞</div><div class="v">${fmtTokens(inputTokens)}</div></div>
          <div class="mini"><div class="l">Ï∂úÎ†• ÌÜ†ÌÅ∞</div><div class="v">${fmtTokens(outputTokens)}</div></div>
          <div class="mini"><div class="l">Ï¥ù ÌÜ†ÌÅ∞</div><div class="v">${fmtTokens(totalTokens)}</div></div>
          <div class="mini"><div class="l">Ïª®ÌÖçÏä§Ìä∏ ÏÇ¨Ïö©Î•†</div><div class="v" style="color:${pctUsed > 70 ? 'var(--red)' : 'var(--green)'};">${pctUsed}%</div></div>
        </div>
      </div>
    </div>
  `;
  document.getElementById('modalBg').classList.add('show');
}

function closeModal(e) {
  if (e && e.target !== document.getElementById('modalBg')) return;
  document.getElementById('modalBg').classList.remove('show');
}

// ===== HELPERS =====
function getMeta(id) { return META[id] || { name: id, emoji: '‚ùì', role: id, model: 'unknown', modelId: '', color: '#666', origin: '-', deny: [] }; }
let connError = null;
function setConn(state, err) {
  if (err) connError = err;
  const dot = document.getElementById('connDot');
  const label = document.getElementById('connLabel');
  const badge = document.getElementById('connBadge');
  dot.className = 'dot ' + state;
  const labels = { on: STATIC_MODE ? 'GCS Ï†ïÏ†Å' : `Gateway :${GW_PORT}`, off: 'Ïó∞Í≤∞ ÎÅäÍπÄ', connecting: STATIC_MODE ? 'Î°úÎî© Ï§ë...' : 'Ïó∞Í≤∞ Ï§ë...' };
  label.textContent = labels[state];
  if (badge) badge.title = (state === 'off' && connError) ? connError : (STATIC_MODE ? 'ÌÅ¥Î¶≠ÌïòÏó¨ Ïû¨ÏãúÎèÑ' : 'ÌÅ¥Î¶≠ÌïòÏó¨ Gateway Ïû¨ÏãúÏûë');
}
function fmtTokens(n) {
  if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
  if (n >= 1000) return (n / 1000).toFixed(1) + 'K';
  return String(n);
}
function buildSessionMap() {
  const byAgent = gwData.status?.sessions?.byAgent || [];
  const map = {};
  byAgent.forEach(a => { if (a.recent?.length) map[a.agentId] = a.recent[0]; });
  return map;
}

// Gateway restart via conn badge
let gwRestarting = false;
function onConnBadgeClick() {
  if (STATIC_MODE) {
    if (!connected) fetchStatic(); // Ïû¨ÏãúÎèÑ
    return;
  }
  if (connected) return; // already connected, no action needed
  if (gwRestarting) return; // already restarting
  gwRestarting = true;
  const badge = document.getElementById('connBadge');
  const label = document.getElementById('connLabel');
  badge.classList.add('restarting');
  label.textContent = 'Gateway ÏãúÏûë Ï§ë...';
  fetch('/api/gateway/restart', { method: 'POST' })
    .then(function(r) { return r.json(); })
    .then(function(data) {
      if (data.ok) {
        label.textContent = 'Ïû¨ÏãúÏûë ÏôÑÎ£å, Ïó∞Í≤∞ Ï§ë...';
        // Give gateway a moment to start, then reconnect
        setTimeout(function() {
          gwRestarting = false;
          badge.classList.remove('restarting');
          connect();
        }, 3000);
      } else {
        label.textContent = 'ÏãúÏûë Ïã§Ìå®: ' + (data.stderr || data.error || 'unknown');
        gwRestarting = false;
        badge.classList.remove('restarting');
      }
    })
    .catch(function(err) {
      label.textContent = 'ÏÑúÎ≤Ñ Ïó∞Í≤∞ Ïã§Ìå®';
      gwRestarting = false;
      badge.classList.remove('restarting');
    });
}

// Clock
function tick() {
  const now = new Date();
  document.getElementById('clock').textContent = now.toLocaleTimeString('ko-KR', { hour:'2-digit', minute:'2-digit', second:'2-digit', hour12: false });
  if (rendered) renderRateLimit(); // Ïπ¥Ïö¥Ìä∏Îã§Ïö¥ Îß§ Ï¥à Í∞±Ïã†
}
setInterval(tick, 1000); tick();

// Periodic refresh - Ï±ÑÌåÖ Î°úÍ∑∏ Ïã§ÏãúÍ∞Ñ (fetchTasks), ÎÇòÎ®∏ÏßÄÎäî Îçú ÏûêÏ£º
if (!STATIC_MODE) {
  setInterval(() => { if (connected) fetchAll(); }, 30000);
  setInterval(() => { if (connected && rendered) fetchTasks(); }, 5000);
}

// Keyboard
document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });

// Resize
window.addEventListener('resize', () => { if (gwData.cost) renderChart(); });

// Start
connect();
</script>
</body>
</html>
