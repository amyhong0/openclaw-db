<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AMY UNIVERSE</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600&display=swap');
  *{margin:0;padding:0;box-sizing:border-box;}
  :root{
    --bg-0:#0b0e14;--bg-1:#111620;--bg-2:#171d2a;--bg-3:#1e2536;
    --border:#2a3345;--border-light:#3a4560;
    --text-0:#f0f3f8;--text-1:#c5ccdb;--text-2:#8892a6;--text-3:#5a6478;
    --accent:#6c8cff;--accent-dim:rgba(108,140,255,.12);
    --green:#3dd68c;--green-dim:rgba(61,214,140,.12);
    --yellow:#f5c542;--yellow-dim:rgba(245,197,66,.12);
    --red:#f5564a;--red-dim:rgba(245,86,74,.12);
    --orange:#f5944a;--orange-dim:rgba(245,148,74,.12);
    --purple:#b07aff;--purple-dim:rgba(176,122,255,.12);
    --radius:12px;--radius-sm:8px;
  }
  body{background:var(--bg-0);color:var(--text-0);font-family:'Inter',-apple-system,sans-serif;min-height:100vh;line-height:1.5;}

  /* TOPBAR */
  .topbar{display:flex;align-items:center;justify-content:space-between;padding:0 28px;height:56px;background:var(--bg-1);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:100;}
  .topbar-left{display:flex;align-items:center;gap:14px;}
  .topbar-logo{font-size:18px;font-weight:800;letter-spacing:1.5px;display:flex;align-items:center;gap:10px;}
  .topbar-logo .ver{color:var(--text-3);font-weight:400;font-size:11px;letter-spacing:0;}
  .topbar-right{display:flex;align-items:center;gap:16px;}
  .topbar-time{font-family:'JetBrains Mono',monospace;font-size:13px;color:var(--text-2);}
  .conn-badge{font-size:12px;color:var(--text-2);display:flex;align-items:center;gap:6px;padding:4px 12px;background:var(--bg-2);border-radius:20px;border:1px solid var(--border);cursor:pointer;transition:all .15s;}
  .conn-badge:hover{border-color:var(--accent);background:var(--bg-3);}
  .conn-badge.restarting{border-color:var(--yellow);animation:pulse 1s ease-in-out infinite;}
  .dot{width:8px;height:8px;border-radius:50%;}
  .dot.on{background:var(--green);box-shadow:0 0 8px var(--green);animation:pulse 2s ease-in-out infinite;}
  .dot.off{background:var(--red);box-shadow:0 0 8px var(--red);}
  .dot.connecting{background:var(--yellow);box-shadow:0 0 8px var(--yellow);animation:pulse 1s ease-in-out infinite;}
  @keyframes pulse{0%,100%{opacity:1;}50%{opacity:.4;}}

  /* SUMMARY */
  .summary{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;padding:20px 28px;background:var(--bg-1);border-bottom:1px solid var(--border);}
  .s-card{background:var(--bg-2);border:1px solid var(--border);border-radius:var(--radius);padding:16px 20px;display:flex;align-items:center;gap:14px;}
  .s-icon{width:44px;height:44px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;}
  .s-label{font-size:12px;color:var(--text-2);font-weight:500;text-transform:uppercase;letter-spacing:.5px;}
  .s-value{font-size:22px;font-weight:800;letter-spacing:-.5px;line-height:1.2;}
  .s-sub{font-size:11px;color:var(--text-3);margin-top:2px;}
  .s-quota{margin-top:6px;}
  .s-quota-bar{width:100%;height:5px;background:var(--bg-0);border-radius:3px;overflow:hidden;}
  .s-quota-fill{height:100%;border-radius:3px;transition:width 1.5s ease;}
  .s-quota-text{font-size:10px;font-family:'JetBrains Mono',monospace;color:var(--text-2);margin-top:3px;display:flex;justify-content:space-between;}

  /* MAIN GRID */
  .main-grid{display:grid;grid-template-columns:1fr 1fr;gap:0;min-height:calc(100vh - 56px - 100px);}
  .section{padding:24px 28px;border-bottom:1px solid var(--border);border-right:1px solid var(--border);}
  .section:nth-child(even){border-right:none;}
  .section.full{grid-column:1/-1;border-right:none;}
  .sec-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;}
  .sec-title{font-size:15px;font-weight:700;display:flex;align-items:center;gap:8px;}
  .sec-badge{font-size:11px;color:var(--text-2);background:var(--bg-3);padding:3px 10px;border-radius:20px;border:1px solid var(--border);font-weight:500;}

  /* ORG CHART */
  .org{display:flex;flex-direction:column;align-items:center;padding:16px 0;gap:0;}
  .org-node{background:var(--bg-2);border:1.5px solid var(--border);border-radius:var(--radius-sm);padding:8px 14px;text-align:center;cursor:pointer;transition:all .2s;position:relative;min-width:120px;max-width:160px;}
  .org-node:hover{border-color:var(--accent);transform:translateY(-2px);box-shadow:0 4px 16px rgba(108,140,255,.15);}
  .org-node::before{content:'';position:absolute;top:0;left:0;width:100%;height:3px;border-radius:var(--radius-sm) var(--radius-sm) 0 0;background:var(--c,var(--accent));}
  .org-node.boss-node{min-width:130px;max-width:160px;padding:8px 14px;}
  .org-node.pm-node{min-width:130px;max-width:160px;padding:8px 14px;}
  .org-emoji{font-size:22px;margin-bottom:2px;}
  .org-name{font-weight:700;font-size:12px;}
  .org-role{font-size:10px;color:var(--text-2);font-weight:500;}
  .org-model{font-size:9px;font-family:'JetBrains Mono',monospace;color:var(--text-3);margin-top:1px;}
  .org-node .ind{position:absolute;top:6px;right:6px;width:7px;height:7px;border-radius:50%;}
  .vline{width:2px;height:24px;background:var(--border-light);flex-shrink:0;}
  .org-connector{display:flex;flex-direction:column;align-items:center;width:100%;}
  .hline-wrap{position:relative;width:100%;display:flex;justify-content:center;}
  .hline{height:2px;background:var(--border-light);}
  .org-rows{display:flex;flex-direction:column;align-items:center;gap:0;width:100%;}
  .team-row{display:flex;justify-content:center;gap:0;flex-wrap:nowrap;}
  .team-col{display:flex;flex-direction:column;align-items:center;min-width:100px;}
  .vline-sm{width:2px;height:16px;background:var(--border-light);}

  /* AGENT LIST */
  .agent-list{display:flex;flex-direction:column;gap:10px;}
  .a-row{display:flex;align-items:center;gap:14px;padding:14px 16px;background:var(--bg-2);border:1px solid var(--border);border-radius:var(--radius);cursor:pointer;transition:all .2s;}
  .a-row:hover{border-color:var(--accent);background:var(--bg-3);}
  .a-ava{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:22px;background:var(--bg-3);border:1.5px solid var(--border);flex-shrink:0;position:relative;}
  .a-ava .odot{position:absolute;bottom:-1px;right:-1px;width:10px;height:10px;border-radius:50%;border:2px solid var(--bg-2);}
  .a-info{flex:1;min-width:0;}
  .a-name{font-weight:700;font-size:14px;display:flex;align-items:center;gap:6px;}
  .a-name span{font-size:11px;color:var(--text-3);font-weight:400;}
  .a-task{font-size:12px;color:var(--text-2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-top:2px;}
  .a-task-detail{font-size:11px;color:var(--text-3);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-top:2px;max-width:100%;}
  .a-task-detail .label{color:var(--text-3);font-weight:500;margin-right:4px;}
  .a-right{flex-shrink:0;display:flex;flex-direction:column;align-items:flex-end;gap:4px;}
  .tag{font-size:11px;font-weight:600;padding:3px 10px;border-radius:20px;white-space:nowrap;}
  .tag.on{background:var(--green-dim);color:var(--green);}
  .tag.off{background:var(--bg-3);color:var(--text-3);}
  .tag.no-session{background:var(--bg-3);color:var(--text-3);}
  .pbar{width:90px;height:4px;background:var(--bg-0);border-radius:2px;overflow:hidden;}
  .pfill{height:100%;border-radius:2px;transition:width 1.5s ease;}
  .token-info{font-size:10px;font-family:'JetBrains Mono',monospace;color:var(--text-3);}

  /* API GRID */
  .api-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:16px;align-items:stretch;}
  .api-card{background:var(--bg-2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:12px 10px;text-align:center;transition:border-color .2s,box-shadow .2s;position:relative;overflow:hidden;display:flex;flex-direction:column;}
  .api-card:hover{border-color:var(--accent);box-shadow:0 2px 12px rgba(108,140,255,.1);}
  .api-card::before{content:'';position:absolute;top:0;left:0;width:100%;height:3px;background:var(--c,var(--accent));}
  .api-card .emoji{font-size:20px;margin-bottom:2px;}
  .api-card .name{font-weight:700;font-size:12px;margin-bottom:1px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .api-card .model{font-size:9px;font-family:'JetBrains Mono',monospace;color:var(--text-3);margin-bottom:6px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .api-card .card-body{margin-top:auto;}
  .ubar{width:100%;height:5px;background:var(--bg-0);border-radius:3px;overflow:hidden;margin:6px 0 3px;}
  .ufill{height:100%;border-radius:3px;transition:width 2s ease;}
  .ufill.low{background:linear-gradient(90deg,#2a9d5c,var(--green));}
  .ufill.mid{background:linear-gradient(90deg,#d4a017,var(--yellow));}
  .ufill.high{background:linear-gradient(90deg,#d46317,var(--orange));}
  .ufill.crit{background:linear-gradient(90deg,#c0392b,var(--red));animation:bpulse 1.5s ease-in-out infinite;}
  @keyframes bpulse{0%,100%{opacity:1;}50%{opacity:.7;}}
  .upct{font-size:10px;font-weight:600;font-family:'JetBrains Mono',monospace;text-align:right;}
  .api-row{display:flex;justify-content:space-between;align-items:center;font-size:11px;padding:3px 0;border-top:1px solid var(--border);}
  .api-row:first-of-type{border-top:none;}
  .api-row .l{color:var(--text-2);font-size:10px;}
  .api-row .v{font-weight:700;font-family:'JetBrains Mono',monospace;font-size:11px;}
  .api-alert{display:inline-flex;align-items:center;gap:4px;font-size:10px;font-weight:600;padding:2px 8px;border-radius:4px;margin-top:4px;}

  /* COST CHART */
  .cost-chart{background:var(--bg-2);border:1px solid var(--border);border-radius:var(--radius);padding:20px;}
  .cost-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;}
  .cost-title{font-size:13px;font-weight:600;color:var(--text-1);}
  .chart-area{position:relative;height:180px;overflow:hidden;}
  .chart-canvas{width:100%;height:100%;}
  .chart-x{display:flex;justify-content:space-between;font-size:10px;font-family:'JetBrains Mono',monospace;color:var(--text-3);padding:4px 40px 0;}

  /* MODAL */
  .modal-bg{display:none;position:fixed;inset:0;background:rgba(0,0,0,.65);z-index:200;backdrop-filter:blur(4px);}
  .modal-bg.show{display:flex;align-items:center;justify-content:center;}
  .modal{background:var(--bg-1);border:1px solid var(--border);border-radius:16px;width:560px;max-height:85vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.5);animation:modin .25s ease-out;}
  @keyframes modin{from{opacity:0;transform:scale(.95) translateY(10px);}to{opacity:1;transform:scale(1) translateY(0);}}
  .m-top{padding:24px 28px 20px;border-bottom:1px solid var(--border);display:flex;align-items:flex-start;gap:16px;}
  .m-ava{width:56px;height:56px;border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:30px;border:2px solid var(--border);background:var(--bg-2);flex-shrink:0;}
  .m-info{flex:1;}
  .m-name{font-size:20px;font-weight:800;display:flex;align-items:center;gap:8px;}
  .m-role{font-size:13px;color:var(--text-2);margin-top:2px;}
  .m-model{font-size:11px;font-family:'JetBrains Mono',monospace;color:var(--text-3);margin-top:4px;}
  .m-close{background:var(--bg-3);border:1px solid var(--border);color:var(--text-2);width:32px;height:32px;border-radius:8px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:16px;transition:all .15s;}
  .m-close:hover{background:var(--red-dim);color:var(--red);}
  .m-body{padding:20px 28px 24px;}
  .m-sec{margin-bottom:20px;}
  .m-sec-t{font-size:12px;font-weight:600;color:var(--text-2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:10px;display:flex;align-items:center;gap:6px;}
  .chip-grid{display:flex;flex-wrap:wrap;gap:6px;}
  .chip{font-size:11px;padding:4px 10px;border-radius:6px;font-weight:500;border:1px solid;}
  .chip.ok{background:var(--green-dim);color:var(--green);border-color:rgba(61,214,140,.25);}
  .chip.no{background:var(--red-dim);color:var(--red);border-color:rgba(245,86,74,.25);text-decoration:line-through;opacity:.7;}
  .mini-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
  .mini{background:var(--bg-2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:12px;text-align:center;}
  .mini .l{font-size:11px;color:var(--text-2);margin-bottom:4px;}
  .mini .v{font-size:18px;font-weight:800;font-family:'JetBrains Mono',monospace;}

  /* RESPONSIVE */
  @media(max-width:1400px){.api-grid{grid-template-columns:repeat(3,1fr);}}
  @media(max-width:900px){.main-grid{grid-template-columns:1fr;}.section{border-right:none;}.summary{grid-template-columns:repeat(2,1fr);}.api-grid{grid-template-columns:repeat(2,1fr);}}
  @media(max-width:600px){.summary{grid-template-columns:1fr;}.team-row{flex-wrap:wrap;justify-content:center;}.api-grid{grid-template-columns:repeat(2,1fr);}}

  /* CHAT LOG */
  .chat-tabs{display:flex;gap:4px;overflow-x:auto;padding-bottom:8px;border-bottom:1px solid var(--border);margin-bottom:12px;flex-shrink:0;}
  .chat-tab{padding:6px 14px;border-radius:20px;font-size:12px;font-weight:600;cursor:pointer;white-space:nowrap;border:1px solid var(--border);background:var(--bg-2);color:var(--text-2);transition:all .15s;user-select:none;pointer-events:auto;position:relative;z-index:2;}
  .chat-tab:hover{border-color:var(--accent);color:var(--text-1);}
  .chat-tab.active{background:var(--accent-dim);border-color:var(--accent);color:var(--accent);}
  .chat-tab .tab-dot{display:inline-block;width:6px;height:6px;border-radius:50%;margin-right:5px;pointer-events:none;}
  .chat-msgs{max-height:calc(100vh - 400px);min-height:200px;overflow-y:scroll;display:flex;flex-direction:column;gap:6px;padding:4px 0;}
  .chat-msg{display:flex;gap:10px;padding:10px 14px;border-radius:var(--radius-sm);background:var(--bg-2);border:1px solid var(--border);position:relative;}
  .chat-msg.user{border-left:3px solid var(--accent);}
  .chat-msg.assistant{border-left:3px solid var(--green);}
  .chat-msg.spawn{border-left:3px solid var(--orange);background:var(--orange-dim);}
  .chat-msg .cm-ava{flex-shrink:0;width:28px;height:28px;border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:14px;background:var(--bg-3);}
  .chat-msg .cm-body{flex:1;min-width:0;}
  .chat-msg .cm-head{display:flex;align-items:center;gap:6px;margin-bottom:3px;}
  .chat-msg .cm-role{font-size:10px;font-weight:700;letter-spacing:.5px;}
  .chat-msg .cm-agent-tag{font-size:9px;padding:1px 6px;border-radius:10px;font-weight:600;}
  .chat-msg .cm-text{font-size:12px;color:var(--text-1);line-height:1.5;white-space:pre-wrap;word-break:break-word;}
  .chat-msg .cm-time{font-size:10px;color:var(--text-3);font-family:'JetBrains Mono',monospace;flex-shrink:0;align-self:flex-start;margin-top:2px;}
  .chat-empty{text-align:center;padding:40px 20px;color:var(--text-3);font-size:13px;}
  .chat-divider{display:flex;align-items:center;gap:10px;padding:4px 0;color:var(--text-3);font-size:10px;font-weight:600;}
  .chat-divider::before,.chat-divider::after{content:'';flex:1;height:1px;background:var(--border);}
  .chat-arrow{font-size:11px;color:var(--orange);font-weight:700;margin:0 2px;}

  /* Empty state */
  .empty{text-align:center;padding:40px 20px;color:var(--text-3);}
  .empty .icon{font-size:48px;margin-bottom:12px;opacity:.5;}
  .empty .msg{font-size:14px;}

  ::-webkit-scrollbar{width:5px;}::-webkit-scrollbar-track{background:transparent;}::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px;}
</style>
</head>
<body>

<div class="topbar">
  <div class="topbar-left">
    <div class="topbar-logo">ğŸ± AMY UNIVERSE <span class="ver" id="gwVersion"></span></div>
  </div>
  <div class="topbar-right">
    <div class="conn-badge" id="connBadge" onclick="onConnBadgeClick()" title="í´ë¦­í•˜ì—¬ Gateway ì¬ì‹œì‘">
      <div class="dot" id="connDot"></div>
      <span id="connLabel">ì—°ê²° ì¤‘...</span>
    </div>
    <div class="topbar-time" id="clock"></div>
  </div>
</div>

<div class="summary">
  <div class="s-card">
    <div class="s-icon" style="background:var(--accent-dim);">ğŸ¤–</div>
    <div>
      <div class="s-label">ì—ì´ì „íŠ¸</div>
      <div class="s-value" id="sAgentCount">-</div>
      <div class="s-sub" id="sAgentSub">ë¡œë”© ì¤‘...</div>
    </div>
  </div>
  <div class="s-card">
    <div class="s-icon" style="background:var(--green-dim);">ğŸ’¬</div>
    <div>
      <div class="s-label">í™œì„± ì„¸ì…˜</div>
      <div class="s-value" id="sSessionCount">-</div>
      <div class="s-sub" id="sSessionSub">-</div>
    </div>
  </div>
  <div class="s-card">
    <div class="s-icon" style="background:var(--yellow-dim);">ğŸª™</div>
    <div style="flex:1;">
      <div class="s-label">Claude í† í° <span style="font-size:10px;color:var(--text-3);text-transform:none;letter-spacing:0;font-weight:400;">Â· Max 20x</span></div>
      <div class="s-value" id="sTokens">-</div>
      <div class="s-sub" id="sTokenCost">-</div>
      <div class="s-quota" id="sQuota">
        <div class="s-quota-bar"><div class="s-quota-fill" id="sQuotaFill" style="width:0%;background:var(--green);"></div></div>
        <div class="s-quota-text"><span id="sQuotaUsed">-</span><span id="sQuotaLimit">-</span></div>
      </div>
    </div>
  </div>
  <div class="s-card">
    <div class="s-icon" style="background:var(--purple-dim);">ğŸ“¡</div>
    <div>
      <div class="s-label">ì±„ë„ ìƒíƒœ</div>
      <div class="s-value" id="sChannel">-</div>
      <div class="s-sub" id="sChannelSub">-</div>
    </div>
  </div>
</div>

<div class="main-grid">
  <div class="section">
    <div class="sec-header">
      <div class="sec-title">ğŸ›ï¸ ì¡°ì§ë„</div>
      <div class="sec-badge">ê³ ì–‘ì´ ë§ˆì„ ê°œë°œíŒ€</div>
    </div>
    <div class="org" id="orgChart"><div class="empty"><div class="icon">â³</div><div class="msg">Gateway ì—°ê²° ëŒ€ê¸° ì¤‘...</div></div></div>
  </div>

  <div class="section">
    <div class="sec-header">
      <div class="sec-title">ğŸ“Š API ì‚¬ìš©ëŸ‰ ë° ë¹„ìš©</div>
      <div class="sec-badge" id="costPeriod">ìµœê·¼ 30ì¼</div>
    </div>
    <div class="api-grid" id="apiGrid"></div>
    <div class="cost-chart">
      <div class="cost-header">
        <div class="cost-title">ğŸ“… ì¼ë³„ í† í° ì‚¬ìš©ëŸ‰ ë° ë¹„ìš©</div>
      </div>
      <div class="chart-area"><canvas class="chart-canvas" id="chartCanvas"></canvas></div>
      <div class="chart-x" id="chartX"></div>
    </div>
  </div>

  <div class="section">
    <div class="sec-header">
      <div class="sec-title">ğŸ“¡ ì—ì´ì „íŠ¸ í˜„í™©</div>
      <div class="sec-badge" id="liveLabel">ì‹¤ì‹œê°„</div>
    </div>
    <div class="agent-list" id="agentList"><div class="empty"><div class="icon">â³</div><div class="msg">ë°ì´í„° ë¡œë”© ì¤‘...</div></div></div>
  </div>

  <div class="section">
    <div class="sec-header">
      <div class="sec-title">ğŸ’¬ ì—ì´ì „íŠ¸ ì±„íŒ… ë¡œê·¸</div>
      <div class="sec-badge" id="chatBadge">ëŒ€í™” ë‚´ì—­</div>
    </div>
    <div class="chat-tabs" id="chatTabs"></div>
    <div class="chat-msgs" id="chatMsgs"><div class="chat-empty">íƒ­ì„ ì„ íƒí•˜ë©´ ëŒ€í™” ë‚´ì—­ì´ í‘œì‹œë©ë‹ˆë‹¤</div></div>
  </div>
</div>

<div class="modal-bg" id="modalBg" onclick="closeModal(event)">
  <div class="modal" id="modalEl" onclick="event.stopPropagation()"></div>
</div>

<script>
// ===== CONFIG =====
const GW_HOST = location.hostname || 'localhost';
const GW_PORT = location.port || 8080;
// ~/.openclaw/openclaw.json ì˜ gateway.auth.token ê°’ (ë¡œì»¬ WebSocket ëª¨ë“œìš©)
const GW_TOKEN = 'REPLACE_WITH_YOUR_GATEWAY_TOKEN';

// GCS ì •ì  ëª¨ë“œ: ?static=1 ë˜ëŠ” ?data=URL (status.json ì£¼ì†Œ)
const urlParams = new URLSearchParams(location.search);
const STATIC_MODE = urlParams.has('static') || urlParams.has('data');
const STATUS_JSON_URL = urlParams.get('data') || (STATIC_MODE ? './status.json' : null);

// Agent metadata (from openclaw.json + IDENTITY.md)
const META = {
  main:      { name:'ëª¨ì°Œ', emoji:'ğŸ±', role:'PM / ì´ê´„ ë§ˆì„ ì´Œì¥ëƒ¥', model:'Claude Opus 4.6', modelId:'anthropic/claude-opus-4-6', color:'#ff8844', origin:'ê³ ì–‘ì´ ë§ˆì„ ì‹œì²­', deny:[] },
  secretary: { name:'ë£¨ë‚˜', emoji:'ğŸŒ™', role:'ë¹„ì„œ / ë‹¬ë¹› ë¹„ì„œëƒ¥', model:'GPT-5.2', modelId:'openai/gpt-5.2', color:'#c4a6ff', origin:'ê³ ì–‘ì´ ë§ˆì„ ì‹œì²­ ì˜†ë°©', deny:['browser','canvas'] },
  pm:        { name:'ëª¨ì°Œ(PM)', emoji:'ğŸ±', role:'PM(ì„œë¸Œ) / ì´Œì¥ ë¶„ì‹ ëƒ¥', model:'Claude Opus 4.6', modelId:'anthropic/claude-opus-4-6', color:'#ff8844', origin:'ê³ ì–‘ì´ ë§ˆì„ ì‹œì²­', deny:['exec','process','write','edit','apply_patch','browser','canvas'] },
  backend:   { name:'ê¹Œë¯¸', emoji:'ğŸˆâ€â¬›', role:'Backend / ì§€í•˜ ëŒ€ì¥ì¥ì´ëƒ¥', model:'Claude Sonnet 4.6', modelId:'anthropic/claude-sonnet-4-6', color:'#4488ff', origin:'ê³¨ëª©ê¸¸ ì§€í•˜ ì‘ì—…ì‹¤', deny:['browser','canvas'] },
  frontend:  { name:'ì†œì´', emoji:'ğŸ±', role:'Frontend / ê½ƒê°€ê²Œ ë””ìì´ë„ˆëƒ¥', model:'Claude Sonnet 4.6', modelId:'anthropic/claude-sonnet-4-6', color:'#ff44aa', origin:'ì–¸ë• ìœ„ ê½ƒê°€ê²Œ', deny:['browser','canvas'] },
  devops:    { name:'í˜¸ë‘ì´', emoji:'ğŸ¯', role:'DevOps / ê°•ê°€ ëª©ìˆ˜ëƒ¥', model:'Gemini 2.5 Flash', modelId:'google/gemini-2.5-flash', color:'#44ffaa', origin:'ê°•ê°€ ëª©ê³µì†Œ', deny:['browser','canvas'] },
  qa:        { name:'ë‚˜ë¹„', emoji:'ğŸˆ', role:'QA / ì§€ë¶• ìœ„ íƒì •ëƒ¥', model:'Gemini 2.5 Flash', modelId:'google/gemini-2.5-flash', color:'#f5c542', origin:'ì§€ë¶• ìœ„ ë§ë£¨', deny:['write','edit','apply_patch','browser','canvas'] },
  reviewer:  { name:'ë‹¬ì´', emoji:'ğŸ˜º', role:'Code Reviewer / ë„ì„œê´€ ì‚¬ì„œëƒ¥', model:'Claude Opus 4.6', modelId:'anthropic/claude-opus-4-6', color:'#b07aff', origin:'ë§ˆì„ ë„ì„œê´€ ì°½ê°€', deny:['write','edit','apply_patch','exec','process','browser','canvas'] },
  debugger:  { name:'ë‘ë¶€', emoji:'ğŸ¾', role:'Debugger / ë§ˆì„ ìˆ˜ì˜ì‚¬ëƒ¥', model:'Claude Opus 4.6', modelId:'anthropic/claude-opus-4-6', color:'#ff6b6b', origin:'ë§ˆì„ ì§„ë£Œì†Œ', deny:['browser','canvas'] },
  designer:  { name:'êµ¬ë¦„', emoji:'ğŸ¨', role:'UI/UX Designer / ë§ˆì„ í™”ê°€ëƒ¥', model:'Claude Sonnet 4.6', modelId:'anthropic/claude-sonnet-4-6', color:'#45b7d1', origin:'ê´‘ì¥ ì•„í‹€ë¦¬ì—', deny:['exec','process'] }
};

const ALL_TOOLS = ['read','write','edit','apply_patch','exec','process','browser','canvas','sessions'];

// Max êµ¬ë…ì œ í•œë„ (5ì‹œê°„ ë¡¤ë§ ìœˆë„ìš° ê¸°ì¤€)
// Max 5x ($100/mo): ~88K tokens/5h window
// Max 20x ($200/mo): ~220K tokens/5h window
// ì¼ì¼ í•œë„ ì¶”ì •: 5h window * ~4.8 = ~1.06M (Max 20x ê¸°ì¤€)
const MAX_PLAN = {
  name: 'Max 20x',
  price: '$200/mo',
  windowTokens: 220000,       // 5ì‹œê°„ ìœˆë„ìš°ë‹¹
  windowHours: 5,
  dailyEstimate: 1056000,     // ì¼ì¼ ì¶”ì • (220K * 4.8)
  monthlyEstimate: 31680000,  // ì›”ê°„ ì¶”ì • (ì¼ì¼ * 30)
};

// ===== STATE =====
let ws = null;
let connected = false;
let reqId = 0;
let pending = {};
let gwData = { health: null, status: null, presence: [], usage: null, cost: null, agents: null, sessions: null };
let taskMap = {}; // agentId -> { task: string, lastMsg: string, status: string }
let chatHistory = {}; // agentId -> [{ role, content, timestamp }]
let activeChatAgent = '_all';

// ===== GCS ì •ì  ëª¨ë“œ (fetch) =====
async function fetchStatic() {
  if (!STATUS_JSON_URL) return;
  setConn('connecting');
  try {
    const r = await fetch(STATUS_JSON_URL + (STATUS_JSON_URL.includes('?') ? '&' : '?') + 't=' + Date.now());
    if (!r.ok) throw new Error(r.status);
    const data = await r.json();
    gwData.health = data.health;
    gwData.status = data.status;
    gwData.presence = data.presence || [];
    gwData.usage = data.usage;
    gwData.cost = data.cost;
    gwData.sessions = data.sessions;
    if (data.taskMap) Object.assign(taskMap, data.taskMap);
    if (data.chatHistory) Object.assign(chatHistory, data.chatHistory);
    connected = true;
    setConn('on');
    document.getElementById('gwVersion').textContent = `GCS ì •ì  Â· ${data.updatedAt ? new Date(data.updatedAt).toLocaleString('ko-KR') : ''}`;
    render();
    patchAgentList();
    renderChatTabs();
    if (activeChatAgent === '_all') renderAllChat(); else if (activeChatAgent) renderChatMessages(activeChatAgent);
  } catch (e) {
    console.error('[AMY] Fetch failed:', e);
    setConn('off');
  }
}

// ===== WS CONNECTION =====
function connect() {
  if (STATIC_MODE && STATUS_JSON_URL) {
    fetchStatic();
    setInterval(fetchStatic, 120000); // 2ë¶„ë§ˆë‹¤
    return;
  }
  setConn('connecting');
  ws = new WebSocket(`ws://${GW_HOST}:${GW_PORT}`);

  ws.onopen = () => { console.log('[AMY] WebSocket opened'); };

  ws.onmessage = (e) => {
    const msg = JSON.parse(e.data);
    if (msg.type === 'event') {
      if (msg.event === 'connect.challenge') {
        sendConnect();
      } else if (msg.event === 'health') {
        fetchAll();
      } else if (msg.event === 'agent') {
        // agent session started/ended - refresh
        fetchAll();
      }
      return;
    }
    if (msg.type === 'res') {
      const cb = pending[msg.id];
      if (cb) { delete pending[msg.id]; cb(msg); }

      // After hello-ok, do initial fetch
      if (msg.id === 'connect') {
        console.log('[AMY] Connect response:', msg.ok, msg.error ? JSON.stringify(msg.error) : 'success');
      }
      if (msg.id === 'connect' && msg.ok) {
        connected = true;
        setConn('on');
        const p = msg.payload;
        document.getElementById('gwVersion').textContent = `Gateway ${p.server?.host || ''} Â· ${p.server?.version || 'dev'}`;
        fetchAll();
      }
    }
  };

  ws.onclose = (ev) => { connected = false; setConn('off'); console.log('[AMY] WebSocket closed:', ev.code, ev.reason); setTimeout(connect, 3000); };
  ws.onerror = (err) => { console.error('[AMY] WebSocket error:', err); };
}

function sendConnect() {
  const frame = {
    type:'req', id:'connect', method:'connect',
    params: {
      minProtocol:3, maxProtocol:3,
      client:{ id:'openclaw-control-ui', version:'dev', platform:'web', mode:'webchat', instanceId: 'amy-dashboard-' + Date.now() },
      role:'operator', scopes:['operator.admin','operator.read','operator.approvals','operator.pairing'],
      caps: [],
      auth:{ token: GW_TOKEN },
      userAgent: navigator.userAgent,
      locale: navigator.language
    }
  };
  ws.send(JSON.stringify(frame));
}

function rpc(method, params = {}) {
  return new Promise((resolve) => {
    reqId++;
    const id = String(reqId);
    pending[id] = (msg) => resolve(msg.ok ? msg.payload : null);
    ws.send(JSON.stringify({ type:'req', id, method, params }));
  });
}

async function fetchAll() {
  if (!connected) return;
  const [health, status, presence, usage, cost, sessions] = await Promise.all([
    rpc('health'), rpc('status'), rpc('system-presence'),
    rpc('usage.status'), rpc('usage.cost'), rpc('sessions.list')
  ]);
  gwData.health = health;
  gwData.status = status;
  gwData.presence = presence;
  gwData.usage = usage;
  gwData.cost = cost;
  gwData.sessions = sessions;
  render();
  fetchTasks();
}

async function fetchTasks() {
  const byAgent = gwData.status?.sessions?.byAgent || [];
  const promises = byAgent.filter(a => a.recent?.length > 0).map(async (a) => {
    const agentId = a.agentId;
    let allSessionMsgs = [];
    // ëª¨ë“  ìµœê·¼ ì„¸ì…˜ì—ì„œ ëŒ€í™” ê°€ì ¸ì˜¤ê¸° (ìµœëŒ€ 3ê°œ ì„¸ì…˜)
    for (const sess of a.recent.slice(0, 3)) {
      const sessionKey = sess.key;
      try {
        const hist = await rpc('chat.history', { sessionKey, limit: 50 }).catch(() => null);
        if (!hist?.messages?.length) continue;
        const msgs = hist.messages;
        // taskMapì€ ê°€ì¥ ìµœê·¼ ì„¸ì…˜ ê¸°ì¤€
        if (allSessionMsgs.length === 0) {
          const firstUser = msgs.find(m => m.role === 'user');
          const taskText = extractText(firstUser);
          const lastAssistant = [...msgs].reverse().find(m => m.role === 'assistant');
          const lastMsg = extractText(lastAssistant);
          const lastRole = msgs[msgs.length - 1]?.role;
          const status = lastRole === 'assistant' ? 'responded' : 'waiting';
          taskMap[agentId] = { task: truncate(taskText, 80), lastMsg: truncate(lastMsg, 120), status, sessionKey };
        }
        // ëª¨ë“  ì„¸ì…˜ ë©”ì‹œì§€ë¥¼ í•©ì¹¨
        allSessionMsgs = allSessionMsgs.concat(msgs.map(m => ({
          role: m.role,
          content: extractText(m),
          timestamp: m.timestamp || null
        })).filter(m => m.content));
      } catch(e) { continue; }
    }
    if (allSessionMsgs.length > 0) {
      chatHistory[agentId] = allSessionMsgs;
    }
  });
  await Promise.all(promises);
  if (rendered) {
    patchAgentList();
    renderChatTabs();
    if (activeChatAgent === '_all') {
      renderAllChat();
    } else if (activeChatAgent) {
      renderChatMessages(activeChatAgent);
    }
  }
}

// ===== REAL-TIME CHAT EVENT HANDLER =====
function handleChatEvent(payload) {
  if (!payload) return;
  const sessionKey = payload.sessionKey || '';
  // Extract agentId from sessionKey (format: "agent:<agentId>:<label>" or "spawn:<agentId>:...")
  const parts = sessionKey.split(':');
  let agentId = parts.length >= 2 ? parts[1] : '';
  if (!agentId) return;

  const m = getMeta(agentId);
  if (!m || m.name === agentId && !META[agentId]) return; // unknown agent

  // Handle different chat event kinds
  const kind = payload.kind;

  if (kind === 'chunk' || kind === 'text') {
    // Streaming text - accumulate into last assistant message
    const text = payload.text || payload.content || '';
    if (!text) return;
    if (!chatHistory[agentId]) chatHistory[agentId] = [];
    const msgs = chatHistory[agentId];
    const last = msgs[msgs.length - 1];
    if (last && last.role === 'assistant' && last._streaming) {
      last.content += text;
    } else {
      msgs.push({ role: 'assistant', content: text, timestamp: Date.now(), _streaming: true });
    }
    refreshChatUI(agentId);
    return;
  }

  if (kind === 'final' || kind === 'message') {
    // Complete message
    const role = payload.role || 'assistant';
    let text = '';
    if (typeof payload.content === 'string') {
      text = payload.content;
    } else if (Array.isArray(payload.content)) {
      const tp = payload.content.find(c => c.type === 'text');
      text = tp?.text || '';
    } else if (payload.text) {
      text = payload.text;
    }
    if (!text) return;

    if (!chatHistory[agentId]) chatHistory[agentId] = [];
    const msgs = chatHistory[agentId];
    // Replace streaming message if exists
    const last = msgs[msgs.length - 1];
    if (last && last._streaming && last.role === role) {
      last.content = text;
      delete last._streaming;
    } else {
      // ì¤‘ë³µ ë°©ì§€: ê°™ì€ role + ê°™ì€ ë‚´ìš©ì˜ ë©”ì‹œì§€ê°€ ë§ˆì§€ë§‰ì— ì´ë¯¸ ìˆìœ¼ë©´ ìŠ¤í‚µ
      const textTrim = text.slice(0, 200);
      if (last && last.role === role && last.content.slice(0, 200) === textTrim) return;
      msgs.push({ role, content: text, timestamp: Date.now() });
    }

    // Update taskMap
    if (role === 'user') {
      if (!taskMap[agentId]) taskMap[agentId] = {};
      taskMap[agentId].task = truncate(text, 80);
    } else if (role === 'assistant') {
      if (!taskMap[agentId]) taskMap[agentId] = {};
      taskMap[agentId].lastMsg = truncate(text, 120);
      taskMap[agentId].status = 'responded';
    }

    if (rendered) patchAgentList();
    refreshChatUI(agentId);
    return;
  }

  if (kind === 'start') {
    // Session started - a user message was sent
    const text = payload.message || payload.text || '';
    if (!text) return;
    if (!chatHistory[agentId]) chatHistory[agentId] = [];
    var existMsgs = chatHistory[agentId];
    var lastExist = existMsgs[existMsgs.length - 1];
    if (!(lastExist && lastExist.role === 'user' && lastExist.content.slice(0, 200) === text.slice(0, 200))) {
      existMsgs.push({ role: 'user', content: text, timestamp: Date.now() });
    }
    if (!taskMap[agentId]) taskMap[agentId] = {};
    taskMap[agentId].task = truncate(text, 80);
    taskMap[agentId].status = 'waiting';
    if (rendered) patchAgentList();
    refreshChatUI(agentId);
    return;
  }

  // Generic fallback: try to extract something useful
  if (payload.messages && Array.isArray(payload.messages)) {
    if (!chatHistory[agentId]) chatHistory[agentId] = [];
    payload.messages.forEach(msg => {
      const text = extractText(msg);
      if (text) {
        chatHistory[agentId].push({ role: msg.role, content: text, timestamp: Date.now() });
      }
    });
    refreshChatUI(agentId);
  }
}

function refreshChatUI(agentId) {
  if (!rendered) return;
  renderChatTabs();
  if (activeChatAgent === '_all') {
    renderAllChat();
  } else if (activeChatAgent === agentId) {
    renderChatMessages(agentId);
  }
}

function extractText(msg) {
  if (!msg) return '';
  const content = msg.content;
  let text = '';
  if (typeof content === 'string') { text = content; }
  else if (Array.isArray(content)) {
    text = content.filter(c => c.type === 'text').map(c => c.text).join('\n');
  }
  // ë””ìŠ¤ì½”ë“œ ë©”íƒ€ë°ì´í„° ì œê±°
  text = text.replace(/^System:.*?\n\n/s, '');
  text = text.replace(/Conversation info \(untrusted metadata\):\n```json\n[\s\S]*?```\n*/g, '');
  return text.trim();
}

function truncate(str, max) {
  if (!str) return '';
  const clean = str.replace(/\n/g, ' ').replace(/\s+/g, ' ').trim();
  return clean.length > max ? clean.slice(0, max) + 'â€¦' : clean;
}

// ===== RENDER =====
let rendered = false;

function render() {
  renderSummary();
  if (!rendered) {
    renderOrg();
    renderAgentList();
    renderApiSection();
    renderChatTabs();
    renderAllChat();
    rendered = true;
  } else {
    patchOrg();
    patchAgentList();
    patchApiSection();
  }
  renderChart();
}

function renderSummary() {
  const s = gwData.status;
  const h = gwData.health;
  const c = gwData.cost;
  const sess = gwData.sessions;

  // Agents
  const agentIds = s?.heartbeat?.agents || [];
  const catAgents = agentIds;
  const hbEnabled = catAgents.filter(a => a.enabled).length;
  document.getElementById('sAgentCount').textContent = catAgents.length;
  document.getElementById('sAgentSub').textContent = `í•˜íŠ¸ë¹„íŠ¸ í™œì„± ${hbEnabled} Â· ë¹„í™œì„± ${catAgents.length - hbEnabled}`;

  // Sessions
  const sessionCount = sess?.count || 0;
  const totalSessions = (s?.sessions?.byAgent || []).reduce((sum, a) => sum + (a.count || 0), 0);
  document.getElementById('sSessionCount').textContent = totalSessions;
  const recentSession = sess?.sessions?.[0];
  document.getElementById('sSessionSub').textContent = recentSession
    ? `ìµœê·¼: ${recentSession.displayName || recentSession.key}`
    : 'ì„¸ì…˜ ì—†ìŒ';

  // Tokens / Cost (Claude ëª¨ë¸ ì„¸ì…˜ë§Œ ì¹´ìš´íŠ¸)
  // usage.cost APIëŠ” í”„ë¡œë°”ì´ë” êµ¬ë¶„ì´ ì—†ìœ¼ë¯€ë¡œ, status.sessions.byAgentì—ì„œ Claude ì„¸ì…˜ë§Œ í•©ì‚°
  const byAgent = s?.sessions?.byAgent || [];
  let claudeTokens = 0;
  let totalAllTokens = 0;
  byAgent.forEach(function(a) {
    (a.recent || []).forEach(function(r) {
      const model = (r.model || '').toLowerCase();
      const tokens = r.totalTokens || 0;
      totalAllTokens += tokens;
      if (model.includes('claude') || model.includes('opus') || model.includes('sonnet') || model.includes('haiku')) {
        claudeTokens += tokens;
      }
    });
  });

  // ë¹„ìš©ì€ usage.cost totalsì—ì„œ Claude ë¹„ìœ¨ë¡œ ì¶”ì •
  const totals = c?.totals;
  const claudeRatio = totalAllTokens > 0 ? claudeTokens / totalAllTokens : 1;
  const claudeCost = totals ? totals.totalCost * claudeRatio : 0;

  const usedTokens = claudeTokens;
  const monthlyLimit = MAX_PLAN.monthlyEstimate;
  const quotaPct = Math.min((usedTokens / monthlyLimit) * 100, 100);
  const quotaColor = quotaPct >= 90 ? 'var(--red)' : quotaPct >= 70 ? 'var(--orange)' : quotaPct >= 40 ? 'var(--yellow)' : 'var(--green)';

  document.getElementById('sTokens').textContent = fmtTokens(usedTokens) + ' / ' + fmtTokens(monthlyLimit);
  document.getElementById('sTokenCost').textContent = usedTokens > 0
    ? `~$${claudeCost.toFixed(2)} Â· Claude only (${c?.days || 30}ì¼ê°„)`
    : 'ë°ì´í„° ì—†ìŒ';

  // Quota bar
  const qFill = document.getElementById('sQuotaFill');
  const qUsed = document.getElementById('sQuotaUsed');
  const qLimit = document.getElementById('sQuotaLimit');
  if (qFill) { qFill.style.width = quotaPct.toFixed(1) + '%'; qFill.style.background = quotaColor; }
  if (qUsed) qUsed.textContent = quotaPct.toFixed(1) + '% ì‚¬ìš©';
  if (qLimit) qLimit.textContent = MAX_PLAN.name + ' (' + MAX_PLAN.price + ')';

  // Channel
  const discord = h?.channels?.discord;
  if (discord) {
    const probe = discord.probe;
    document.getElementById('sChannel').textContent = probe?.ok ? 'Discord âœ“' : 'Discord âœ—';
    document.getElementById('sChannel').style.color = probe?.ok ? 'var(--green)' : 'var(--red)';
    document.getElementById('sChannelSub').textContent = probe?.bot ? `@${probe.bot.username}` : (discord.running ? 'ì‹¤í–‰ ì¤‘' : 'ëŒ€ê¸° ì¤‘');
  }
}

function renderOrg() {
  const chart = document.getElementById('orgChart');
  const fixedOrder = ['main','secretary','backend','frontend','devops','qa','reviewer','debugger','designer'];
  const hbIds = new Set((gwData.status?.heartbeat?.agents || []).map(a => a.agentId));
  // mainì€ í•­ìƒ í‘œì‹œ
  const agentIds = fixedOrder.filter(id => id === 'main' || hbIds.has(id));
  if (agentIds.length === 0) { chart.innerHTML = '<div class="empty"><div class="icon">ğŸ“­</div><div class="msg">ë“±ë¡ëœ ì—ì´ì „íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤</div></div>'; return; }

  const sessionMap = buildSessionMap();

  // ë¹„ì„œì™€ ê°œë°œíŒ€ ë¶„ë¦¬
  const hasSecretary = agentIds.includes('secretary');
  const devTeam = agentIds.filter(id => id !== 'main' && id !== 'secretary');
  const row1 = devTeam.slice(0, 4);
  const row2 = devTeam.slice(4);

  function renderNode(id, extraClass) {
    const m = getMeta(id);
    const on = !!sessionMap[id];
    return `<div class="team-col">
      <div class="vline-sm"></div>
      <div class="org-node ${extraClass||''}" data-org="${id}" style="--c:${m.color}" onclick="openModal('${id}')">
        <div class="ind" data-org-ind="${id}" style="background:${on ? 'var(--green)' : 'var(--text-3)'};box-shadow:0 0 6px ${on ? 'var(--green)' : 'transparent'};"></div>
        <div class="org-emoji">${m.emoji}</div>
        <div class="org-name">${m.name}</div>
        <div class="org-role">${m.role.split('/')[0].trim()}</div>
        <div class="org-model">${m.model}</div>
      </div>
    </div>`;
  }

  function renderTopNode(id, extraClass) {
    const m = getMeta(id);
    const on = !!sessionMap[id];
    return `<div class="org-node ${extraClass||''}" data-org="${id}" style="--c:${m.color}" onclick="openModal('${id}')">
      <div class="ind" data-org-ind="${id}" style="background:${on ? 'var(--green)' : 'var(--text-3)'};box-shadow:0 0 6px ${on ? 'var(--green)' : 'transparent'};"></div>
      <div class="org-emoji">${m.emoji}</div>
      <div class="org-name">${m.name}</div>
      <div class="org-role">${m.role}</div>
      <div class="org-model">${m.model}</div>
    </div>`;
  }

  // ëª¨ì°Œ(main) + ë£¨ë‚˜(secretary) â†’ ê°œë°œíŒ€
  const maxRow = Math.max(row1.length, row2.length);
  const hlineWidth = Math.max(maxRow * 110, 200);

  chart.innerHTML = `
    <div style="position:relative;display:flex;flex-direction:column;align-items:center;">
      ${renderTopNode('main', 'boss-node')}
      ${hasSecretary ? `<div style="position:absolute;left:calc(50% + 100px);top:0;">${renderTopNode('secretary', '')}</div>` : ''}
    </div>
    ${devTeam.length > 0 ? `
      <div class="vline"></div>
      <div class="hline" style="width:${hlineWidth}px;max-width:95%;"></div>
      <div class="org-rows">
        <div class="team-row">${row1.map(id => renderNode(id)).join('')}</div>
        ${row2.length ? `
          <div style="display:flex;justify-content:center;"><div class="vline"></div></div>
          <div class="hline" style="width:${Math.max(row2.length * 110, 200)}px;max-width:95%;"></div>
          <div class="team-row">${row2.map(id => renderNode(id)).join('')}</div>
        ` : ''}
      </div>
    ` : ''}
  `;
}

function renderAgentList() {
  const list = document.getElementById('agentList');
  const byAgent = gwData.status?.sessions?.byAgent || [];
  const fixedOrder = ['main','secretary','backend','frontend','devops','qa','reviewer','debugger','designer'];
  const hbIds = new Set((gwData.status?.heartbeat?.agents || []).map(a => a.agentId));
  const agentIds = fixedOrder.filter(id => hbIds.has(id));
  const sessionMap = buildSessionMap();

  if (agentIds.length === 0) { list.innerHTML = '<div class="empty"><div class="icon">ğŸ“­</div><div class="msg">ì—ì´ì „íŠ¸ ì—†ìŒ</div></div>'; return; }

  list.innerHTML = agentIds.map(id => {
    const m = getMeta(id);
    const sess = sessionMap[id];
    const hasSession = !!sess;
    const hbAgent = (gwData.status?.heartbeat?.agents || []).find(a => a.agentId === id);
    const hbEnabled = hbAgent?.enabled;

    let statusLabel, statusClass;
    if (hasSession) {
      statusLabel = 'ì„¸ì…˜ í™œì„±';
      statusClass = 'on';
    } else {
      statusLabel = 'ì„¸ì…˜ ì—†ìŒ';
      statusClass = 'no-session';
    }

    let taskText = 'ëŒ€ê¸° ì¤‘';
    let taskDetail = '';
    let tokenInfo = '';
    let progressHtml = '';

    // taskMapì—ì„œ ì‹¤ì œ íƒœìŠ¤í¬ ë‚´ìš© ê°€ì ¸ì˜¤ê¸°
    const tm = taskMap[id];
    if (tm && tm.task) {
      taskText = tm.task;
      if (tm.lastMsg) {
        taskDetail = tm.lastMsg;
      }
    } else if (sess) {
      taskText = sess.displayName || 'ì„¸ì…˜ í™œì„±';
    }

    if (sess) {
      const pct = sess.percentUsed || 0;
      const total = sess.totalTokens || 0;
      tokenInfo = `${fmtTokens(total)} tokens Â· ${pct}% ì»¨í…ìŠ¤íŠ¸`;
      progressHtml = `<div class="pbar"><div class="pfill" style="width:${pct}%;background:${pct > 70 ? 'var(--red)' : pct > 40 ? 'var(--yellow)' : 'var(--green)'};"></div></div>`;
    }

    return `
      <div class="a-row" data-agent="${id}" onclick="openModal('${id}')">
        <div class="a-ava" style="border-color:${m.color}20;">
          ${m.emoji}
          <div class="odot" data-agent-dot="${id}" style="background:${hasSession ? 'var(--green)' : 'var(--text-3)'};box-shadow:0 0 5px ${hasSession ? 'var(--green)' : 'transparent'};"></div>
        </div>
        <div class="a-info">
          <div class="a-name">${m.name} <span>${m.role.split('/')[0].trim()}</span></div>
          <div class="a-task" data-agent-task="${id}">${hasSession ? 'ğŸ“‹' : 'ğŸ’¤'} ${taskText}</div>
          ${taskDetail ? `<div class="a-task-detail" data-agent-detail="${id}"><span class="label">â†³ ì‘ë‹µ:</span>${taskDetail}</div>` : `<div class="a-task-detail" data-agent-detail="${id}"></div>`}
          <div class="token-info" data-agent-token="${id}">${tokenInfo}</div>
        </div>
        <div class="a-right">
          <div class="tag ${statusClass}" data-agent-tag="${id}">${statusLabel}</div>
          <div data-agent-pbar="${id}">${progressHtml}</div>
        </div>
      </div>
    `;
  }).join('');
}

function renderApiSection() {
  const grid = document.getElementById('apiGrid');
  const cost = gwData.cost;
  const usage = gwData.usage;

  const byAgent = gwData.status?.sessions?.byAgent || [];
  // ê³ ì • ìˆœì„œ: pm â†’ backend â†’ frontend â†’ devops â†’ qa â†’ reviewer
  const fixedOrder = ['main','secretary','backend','frontend','devops','qa','reviewer','debugger','designer'];

  if (!cost && !usage && byAgent.length === 0) { grid.innerHTML = '<div class="empty" style="grid-column:1/-1;"><div class="icon">ğŸ“­</div><div class="msg">API ì‚¬ìš© ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div></div>'; return; }

  function buildAgentCard(id) {
    const m = getMeta(id);
    const agentSessions = byAgent.find(a => a.agentId === id);
    const recent = agentSessions?.recent || [];
    const totalTokens = recent.reduce((s, r) => s + (r.totalTokens || 0), 0);
    const inputTokens = recent.reduce((s, r) => s + (r.inputTokens || 0), 0);
    const outputTokens = recent.reduce((s, r) => s + (r.outputTokens || 0), 0);
    const contextTokens = recent[0]?.contextTokens || 0;
    const pct = contextTokens > 0 ? (totalTokens / contextTokens * 100) : 0;
    const cls = pct >= 90 ? 'crit' : pct >= 70 ? 'high' : pct >= 40 ? 'mid' : 'low';

    return `<div class="api-card" data-api="${id}" style="--c:${m.color};">
      <div class="emoji">${m.emoji}</div>
      <div class="name">${m.name}</div>
      <div class="model">${m.model}</div>
      <div class="ubar"><div class="ufill ${cls}" data-api-bar="${id}" style="width:${Math.min(pct, 100)}%;"></div></div>
      <div class="upct" data-api-pct="${id}" style="color:${pct >= 70 ? 'var(--orange)' : 'var(--text-2)'};">${pct.toFixed(1)}% ì»¨í…ìŠ¤íŠ¸</div>
      <div class="card-body">
        <div class="api-row"><span class="l">ì„¸ì…˜ ìˆ˜</span><span class="v" data-api-sess="${id}">${recent.length}</span></div>
        <div class="api-row"><span class="l">ì…ë ¥ í† í°</span><span class="v" data-api-in="${id}">${fmtTokens(inputTokens)}</span></div>
        <div class="api-row"><span class="l">ì¶œë ¥ í† í°</span><span class="v" data-api-out="${id}">${fmtTokens(outputTokens)}</span></div>
        <div class="api-row"><span class="l">ì´ í† í°</span><span class="v" data-api-total="${id}">${fmtTokens(totalTokens)}</span></div>
      </div>
    </div>`;
  }

  // Row 1: ì—ì´ì „íŠ¸ 6ê°œ (ê³ ì • ìˆœì„œ, í•­ìƒ í‘œì‹œ)
  const agentCards = fixedOrder.map(buildAgentCard).join('');

  // Row 2: ì´ ë¹„ìš© + Usage providers (í•­ìƒ ê°™ì€ ìœ„ì¹˜)
  let summaryCards = '';

  // ì´ ë¹„ìš© ì¹´ë“œ
  const t = cost?.totals;
  summaryCards += `<div class="api-card" data-api="cost" style="--c:var(--yellow);">
    <div class="emoji">ğŸ’°</div>
    <div class="name">ì´ ë¹„ìš© (${cost?.days || 30}ì¼)</div>
    <div class="model">ì „ì²´ ì—ì´ì „íŠ¸</div>
    <div class="card-body">
      <div class="api-row"><span class="l">ì´ í† í°</span><span class="v" data-cost-tokens>${t ? fmtTokens(t.totalTokens) : '0'}</span></div>
      <div class="api-row"><span class="l">ì…ë ¥</span><span class="v" data-cost-in>${t ? fmtTokens(t.input) : '0'}</span></div>
      <div class="api-row"><span class="l">ì¶œë ¥</span><span class="v" data-cost-out>${t ? fmtTokens(t.output) : '0'}</span></div>
      <div class="api-row"><span class="l">ìºì‹œ ì½ê¸°</span><span class="v" data-cost-cache>${t ? fmtTokens(t.cacheRead) : '0'}</span></div>
      <div class="api-row"><span class="l">ì´ ë¹„ìš©</span><span class="v" data-cost-total style="color:var(--yellow);">$${t ? t.totalCost.toFixed(4) : '0.0000'}</span></div>
    </div>
  </div>`;

  // Usage provider ì¹´ë“œë“¤
  if (usage?.providers?.length) {
    usage.providers.forEach(p => {
      summaryCards += `<div class="api-card" style="--c:var(--accent);">
        <div class="emoji">âš¡</div>
        <div class="name">${p.displayName}</div>
        <div class="model">${p.plan || '-'}</div>
        <div class="card-body">
          ${p.windows.map(w => {
            const pct = w.usedPercent || 0;
            const cls = pct >= 90 ? 'crit' : pct >= 70 ? 'high' : pct >= 40 ? 'mid' : 'low';
            const resetDate = new Date(w.resetAt);
            const resetStr = resetDate.toLocaleDateString('ko-KR',{month:'short',day:'numeric'}) + ' ' + resetDate.toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit'});
            return `
              <div class="api-row"><span class="l">${w.label} ì‚¬ìš©ë¥ </span><span class="v">${pct}%</span></div>
              <div class="ubar"><div class="ufill ${cls}" style="width:${pct}%;"></div></div>
              <div style="font-size:10px;color:var(--text-3);text-align:right;margin-bottom:4px;">ë¦¬ì…‹: ${resetStr}</div>
            `;
          }).join('')}
          ${(p.windows.some(w => (w.usedPercent || 0) >= 80)) ? `<div class="api-alert" style="background:var(--red-dim);color:var(--red);">âš ï¸ ê³¼ë¶€í•˜ ì£¼ì˜!</div>` : ''}
        </div>
      </div>`;
    });
  }

  grid.innerHTML = agentCards + summaryCards;
}

// ===== PATCH (no-flicker update) =====
function patchOrg() {
  const sessionMap = buildSessionMap();
  const allIds = ['pm','backend','frontend','devops','qa','reviewer'];
  allIds.forEach(id => {
    const ind = document.querySelector(`[data-org-ind="${id}"]`);
    if (ind) {
      const on = !!sessionMap[id];
      ind.style.background = on ? 'var(--green)' : 'var(--text-3)';
      ind.style.boxShadow = on ? '0 0 6px var(--green)' : 'none';
    }
  });
}

function patchAgentList() {
  const sessionMap = buildSessionMap();
  const fixedOrder = ['main','secretary','backend','frontend','devops','qa','reviewer','debugger','designer'];
  fixedOrder.forEach(id => {
    const m = getMeta(id);
    const sess = sessionMap[id];
    const hasSession = !!sess;

    const dot = document.querySelector(`[data-agent-dot="${id}"]`);
    if (dot) {
      dot.style.background = hasSession ? 'var(--green)' : 'var(--text-3)';
      dot.style.boxShadow = hasSession ? '0 0 5px var(--green)' : 'none';
    }

    const taskEl = document.querySelector(`[data-agent-task="${id}"]`);
    if (taskEl) {
      const tm = taskMap[id];
      if (tm && tm.task) {
        taskEl.textContent = (hasSession ? 'ğŸ“‹ ' : 'ğŸ’¤ ') + tm.task;
      } else {
        taskEl.textContent = (hasSession ? 'ğŸ“‹ ' : 'ğŸ’¤ ') + (sess ? (sess.displayName || 'ì„¸ì…˜ í™œì„±') : 'ëŒ€ê¸° ì¤‘');
      }
    }

    const detailEl = document.querySelector(`[data-agent-detail="${id}"]`);
    if (detailEl) {
      const tm = taskMap[id];
      if (tm && tm.lastMsg) {
        detailEl.innerHTML = `<span class="label">â†³ ì‘ë‹µ:</span>${tm.lastMsg}`;
      } else {
        detailEl.innerHTML = '';
      }
    }

    const tokenEl = document.querySelector(`[data-agent-token="${id}"]`);
    if (tokenEl) {
      if (sess) {
        const pct = sess.percentUsed || 0;
        const total = sess.totalTokens || 0;
        tokenEl.textContent = `${fmtTokens(total)} tokens Â· ${pct}% ì»¨í…ìŠ¤íŠ¸`;
      } else {
        tokenEl.textContent = '';
      }
    }

    const tagEl = document.querySelector(`[data-agent-tag="${id}"]`);
    if (tagEl) {
      tagEl.textContent = hasSession ? 'ì„¸ì…˜ í™œì„±' : 'ì„¸ì…˜ ì—†ìŒ';
      tagEl.className = 'tag ' + (hasSession ? 'on' : 'no-session');
    }

    const pbarEl = document.querySelector(`[data-agent-pbar="${id}"]`);
    if (pbarEl) {
      if (sess) {
        const pct = sess.percentUsed || 0;
        pbarEl.innerHTML = `<div class="pbar"><div class="pfill" style="width:${pct}%;background:${pct > 70 ? 'var(--red)' : pct > 40 ? 'var(--yellow)' : 'var(--green)'};"></div></div>`;
      } else {
        pbarEl.innerHTML = '';
      }
    }
  });
}

function patchApiSection() {
  const byAgent = gwData.status?.sessions?.byAgent || [];
  const cost = gwData.cost;
  const usage = gwData.usage;
  const fixedOrder = ['main','secretary','backend','frontend','devops','qa','reviewer','debugger','designer'];

  fixedOrder.forEach(id => {
    const agentSessions = byAgent.find(a => a.agentId === id);
    const recent = agentSessions?.recent || [];
    const totalTokens = recent.reduce((s, r) => s + (r.totalTokens || 0), 0);
    const inputTokens = recent.reduce((s, r) => s + (r.inputTokens || 0), 0);
    const outputTokens = recent.reduce((s, r) => s + (r.outputTokens || 0), 0);
    const contextTokens = recent[0]?.contextTokens || 0;
    const pct = contextTokens > 0 ? (totalTokens / contextTokens * 100) : 0;
    const cls = pct >= 90 ? 'crit' : pct >= 70 ? 'high' : pct >= 40 ? 'mid' : 'low';

    const bar = document.querySelector(`[data-api-bar="${id}"]`);
    if (bar) { bar.style.width = Math.min(pct, 100) + '%'; bar.className = 'ufill ' + cls; }
    const pctEl = document.querySelector(`[data-api-pct="${id}"]`);
    if (pctEl) { pctEl.textContent = pct.toFixed(1) + '% ì»¨í…ìŠ¤íŠ¸'; pctEl.style.color = pct >= 70 ? 'var(--orange)' : 'var(--text-2)'; }
    const sessEl = document.querySelector(`[data-api-sess="${id}"]`);
    if (sessEl) sessEl.textContent = recent.length;
    const inEl = document.querySelector(`[data-api-in="${id}"]`);
    if (inEl) inEl.textContent = fmtTokens(inputTokens);
    const outEl = document.querySelector(`[data-api-out="${id}"]`);
    if (outEl) outEl.textContent = fmtTokens(outputTokens);
    const totalEl = document.querySelector(`[data-api-total="${id}"]`);
    if (totalEl) totalEl.textContent = fmtTokens(totalTokens);
  });

  // Cost card
  const t = cost?.totals;
  const ct = document.querySelector('[data-cost-tokens]');
  if (ct) ct.textContent = t ? fmtTokens(t.totalTokens) : '0';
  const ci = document.querySelector('[data-cost-in]');
  if (ci) ci.textContent = t ? fmtTokens(t.input) : '0';
  const co = document.querySelector('[data-cost-out]');
  if (co) co.textContent = t ? fmtTokens(t.output) : '0';
  const cc = document.querySelector('[data-cost-cache]');
  if (cc) cc.textContent = t ? fmtTokens(t.cacheRead) : '0';
  const ctotal = document.querySelector('[data-cost-total]');
  if (ctotal) ctotal.textContent = '$' + (t ? t.totalCost.toFixed(4) : '0.0000');
}

function renderChatTabs() {
  const tabs = document.getElementById('chatTabs');
  const fixedOrder = ['main','secretary','backend','frontend','devops','qa','reviewer','debugger','designer'];
  const hbIds = new Set((gwData.status?.heartbeat?.agents || []).map(a => a.agentId));
  const agentIds = fixedOrder.filter(id => hbIds.has(id));

  const allActive = activeChatAgent === '_all';
  let html = `<div class="chat-tab ${allActive ? 'active' : ''}" data-chat-tab="_all">
    <span class="tab-dot" style="background:var(--accent);"></span>ğŸŒ ì „ì²´
  </div>`;
  html += agentIds.map(id => {
    const m = getMeta(id);
    const hasMsgs = chatHistory[id]?.length > 0;
    const isActive = activeChatAgent === id;
    return `<div class="chat-tab ${isActive ? 'active' : ''}" data-chat-tab="${id}">
      <span class="tab-dot" style="background:${hasMsgs ? m.color : 'var(--text-3)'};"></span>${m.emoji} ${m.name}
    </div>`;
  }).join('');
  tabs.innerHTML = html;
}

// ì´ë²¤íŠ¸ ìœ„ì„ìœ¼ë¡œ íƒ­ í´ë¦­ ì²˜ë¦¬ (debugger ì˜ˆì•½ì–´ ì¶©ëŒ ë°©ì§€)
document.addEventListener('click', function(e) {
  var tab = e.target.closest('[data-chat-tab]');
  if (!tab) return;
  e.preventDefault();
  e.stopPropagation();
  var agentId = tab.getAttribute('data-chat-tab');
  if (!agentId) return;
  activeChatAgent = agentId;
  // ëª¨ë“  íƒ­ì˜ active í´ë˜ìŠ¤ ì¦‰ì‹œ í† ê¸€
  document.querySelectorAll('.chat-tab').forEach(function(t) {
    t.classList.toggle('active', t.getAttribute('data-chat-tab') === agentId);
  });
  if (agentId === '_all') {
    renderAllChat();
  } else {
    renderChatMessages(agentId);
  }
}, true);

function isScrolledToBottom(el) {
  return el.scrollHeight - el.scrollTop - el.clientHeight < 60;
}

function renderChatMessages(agentId) {
  const container = document.getElementById('chatMsgs');
  const wasAtBottom = isScrolledToBottom(container);
  const msgs = chatHistory[agentId];
  const m = getMeta(agentId);

  if (!msgs || msgs.length === 0) {
    container.innerHTML = `<div class="chat-empty">ğŸ“­ ${m.name}ì˜ ëŒ€í™” ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>`;
    return;
  }

  container.innerHTML = msgs.filter(msg => msg.role === 'user' || msg.role === 'assistant').map(msg => {
    const isUser = msg.role === 'user';
    const isSpawn = !isUser && msg.content.includes('sessions_spawn');
    const roleLabel = isUser ? 'ğŸ‘¤ ì§€ì‹œ' : `${m.emoji} ${m.name}`;
    const roleColor = isUser ? 'var(--accent)' : m.color;
    const text = msg.content.length > 800 ? msg.content.slice(0, 800) + 'â€¦' : msg.content;
    const time = msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString('ko-KR', { hour:'2-digit', minute:'2-digit' }) : '';
    const msgClass = isSpawn ? 'spawn' : msg.role;
    return `<div class="chat-msg ${msgClass}">
      <div class="cm-ava">${isUser ? 'ğŸ‘¤' : m.emoji}</div>
      <div class="cm-body">
        <div class="cm-head">
          <div class="cm-role" style="color:${roleColor};">${roleLabel}</div>
          <div class="cm-agent-tag" style="background:${m.color}20;color:${m.color};">${m.role.split('/')[0].trim()}</div>
          ${isSpawn ? '<span class="chat-arrow">â†’ ìœ„ì„</span>' : ''}
        </div>
        <div class="cm-text">${escapeHtml(text)}</div>
      </div>
      ${time ? `<div class="cm-time">${time}</div>` : ''}
    </div>`;
  }).join('');

  if (wasAtBottom) container.scrollTop = container.scrollHeight;
}

function renderAllChat() {
  const container = document.getElementById('chatMsgs');
  const wasAtBottom = isScrolledToBottom(container);

  // ëª¨ë“  ì—ì´ì „íŠ¸ ëŒ€í™”ë¥¼ í•©ì¹˜ê³  íƒ€ì„ìŠ¤íƒ¬í”„ ë˜ëŠ” ìˆœì„œë¡œ ì •ë ¬
  const allMsgs = [];
  const fixedOrder = ['main','secretary','backend','frontend','devops','qa','reviewer','debugger','designer'];

  fixedOrder.forEach(agentId => {
    const msgs = chatHistory[agentId];
    if (!msgs || msgs.length === 0) return;
    msgs.filter(msg => msg.role === 'user' || msg.role === 'assistant').forEach((msg, idx) => {
      allMsgs.push({
        ...msg,
        agentId,
        sortKey: msg.timestamp ? new Date(msg.timestamp).getTime() : (fixedOrder.indexOf(agentId) * 10000 + idx)
      });
    });
  });

  if (allMsgs.length === 0) {
    container.innerHTML = '<div class="chat-empty">ğŸ“­ ì•„ì§ ëŒ€í™” ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>';
    return;
  }

  allMsgs.sort((a, b) => a.sortKey - b.sortKey);

  let lastAgent = null;
  let html = '';

  allMsgs.forEach(msg => {
    const m = getMeta(msg.agentId);
    const isUser = msg.role === 'user';
    const isSpawn = !isUser && msg.content.includes('sessions_spawn');

    // ì—ì´ì „íŠ¸ê°€ ë°”ë€Œë©´ êµ¬ë¶„ì„ 
    if (msg.agentId !== lastAgent) {
      html += `<div class="chat-divider">${m.emoji} ${m.name} ëŒ€í™”</div>`;
      lastAgent = msg.agentId;
    }

    const roleLabel = isUser ? `ğŸ‘¤ â†’ ${m.emoji} ${m.name}` : `${m.emoji} ${m.name}`;
    const roleColor = isUser ? 'var(--accent)' : m.color;
    const text = msg.content.length > 600 ? msg.content.slice(0, 600) + 'â€¦' : msg.content;
    const time = msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString('ko-KR', { hour:'2-digit', minute:'2-digit' }) : '';
    const msgClass = isSpawn ? 'spawn' : msg.role;

    // spawn ê°ì§€: ì–´ë–¤ ì—ì´ì „íŠ¸ì—ê²Œ ìœ„ì„í–ˆëŠ”ì§€ íŒŒì‹±
    let spawnInfo = '';
    if (isSpawn) {
      const agentMatch = msg.content.match(/agentId[:\s]*["']?(\w+)["']?/);
      if (agentMatch) {
        const targetM = getMeta(agentMatch[1]);
        spawnInfo = `<span class="chat-arrow">â†’ ${targetM.emoji} ${targetM.name}ì—ê²Œ ìœ„ì„</span>`;
      } else {
        spawnInfo = '<span class="chat-arrow">â†’ ìœ„ì„</span>';
      }
    }

    html += `<div class="chat-msg ${msgClass}">
      <div class="cm-ava">${isUser ? 'ğŸ‘¤' : m.emoji}</div>
      <div class="cm-body">
        <div class="cm-head">
          <div class="cm-role" style="color:${roleColor};">${roleLabel}</div>
          <div class="cm-agent-tag" style="background:${m.color}20;color:${m.color};">${m.role.split('/')[0].trim()}</div>
          ${spawnInfo}
        </div>
        <div class="cm-text">${escapeHtml(text)}</div>
      </div>
      ${time ? `<div class="cm-time">${time}</div>` : ''}
    </div>`;
  });

  container.innerHTML = html;
  if (wasAtBottom) container.scrollTop = container.scrollHeight;
}

function escapeHtml(str) {
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function renderChart() {
  const canvas = document.getElementById('chartCanvas');
  const ctx = canvas.getContext('2d');
  const daily = gwData.cost?.daily || [];
  if (daily.length === 0) return;

  const dpr = window.devicePixelRatio || 1;
  const rect = canvas.parentElement.getBoundingClientRect();
  canvas.width = rect.width * dpr;
  canvas.height = rect.height * dpr;
  canvas.style.width = rect.width + 'px';
  canvas.style.height = rect.height + 'px';
  ctx.scale(dpr, dpr);
  const W = rect.width, H = rect.height;
  const pL = 50, pR = 10, pT = 10, pB = 5;

  ctx.clearRect(0, 0, W, H);

  const maxTokens = Math.max(1, ...daily.map(d => d.totalTokens));
  const maxCost = Math.max(0.001, ...daily.map(d => d.totalCost));

  // Grid
  ctx.strokeStyle = 'rgba(42,51,69,.5)';
  ctx.lineWidth = 1;
  ctx.font = '10px JetBrains Mono';
  ctx.fillStyle = '#5a6478';
  for (let i = 0; i <= 4; i++) {
    const y = pT + (H - pT - pB) * (1 - i / 4);
    ctx.beginPath(); ctx.moveTo(pL, y); ctx.lineTo(W - pR, y); ctx.stroke();
    ctx.fillText(fmtTokens(Math.round(maxTokens * i / 4)), 2, y + 3);
  }

  // Bars for tokens
  const barW = Math.max(4, (W - pL - pR) / daily.length - 2);
  daily.forEach((d, i) => {
    const x = pL + (W - pL - pR) * (i / daily.length);
    const h = (d.totalTokens / maxTokens) * (H - pT - pB);
    ctx.fillStyle = 'rgba(108,140,255,.4)';
    ctx.fillRect(x, H - pB - h, barW, h);
    // Cost line dot
    const costY = pT + (H - pT - pB) * (1 - d.totalCost / maxCost);
    ctx.beginPath();
    ctx.arc(x + barW / 2, costY, 3, 0, Math.PI * 2);
    ctx.fillStyle = '#f5c542';
    ctx.fill();
  });

  // Cost line
  ctx.beginPath();
  ctx.strokeStyle = '#f5c542';
  ctx.lineWidth = 2;
  daily.forEach((d, i) => {
    const x = pL + (W - pL - pR) * (i / daily.length) + barW / 2;
    const y = pT + (H - pT - pB) * (1 - d.totalCost / maxCost);
    if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
  });
  ctx.stroke();

  // X axis
  const xEl = document.getElementById('chartX');
  const step = Math.max(1, Math.floor(daily.length / 8));
  xEl.innerHTML = daily.filter((_, i) => i % step === 0).map(d => `<span>${d.date.slice(5)}</span>`).join('');
}

// ===== MODAL =====
function openModal(id) {
  const m = getMeta(id);
  const byAgent = gwData.status?.sessions?.byAgent || [];
  const agentSessions = byAgent.find(a => a.agentId === id);
  const recent = agentSessions?.recent || [];
  const totalTokens = recent.reduce((s, r) => s + (r.totalTokens || 0), 0);
  const inputTokens = recent.reduce((s, r) => s + (r.inputTokens || 0), 0);
  const outputTokens = recent.reduce((s, r) => s + (r.outputTokens || 0), 0);
  const pctUsed = recent[0]?.percentUsed || 0;
  const model = recent[0]?.model || m.modelId;
  const hbAgent = (gwData.status?.heartbeat?.agents || []).find(a => a.agentId === id);

  document.getElementById('modalEl').innerHTML = `
    <div class="m-top">
      <div class="m-ava" style="border-color:${m.color}40;">${m.emoji}</div>
      <div class="m-info">
        <div class="m-name">${m.name} <span class="tag ${recent.length ? 'on' : 'off'}" style="font-size:11px;">${recent.length ? 'ì„¸ì…˜ í™œì„±' : 'ì„¸ì…˜ ì—†ìŒ'}</span></div>
        <div class="m-role">${m.role}</div>
        <div class="m-model"><span style="color:${m.color};">â—</span> ${m.model} <span style="margin-left:8px;">ğŸ  ${m.origin}</span></div>
      </div>
      <button class="m-close" onclick="closeModal()">âœ•</button>
    </div>
    <div class="m-body">
      ${taskMap[id]?.task ? `<div class="m-sec">
        <div class="m-sec-t">ğŸ“‹ í˜„ì¬ ì‘ì—…</div>
        <div style="background:var(--bg-2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:12px 16px;">
          <div style="font-size:13px;font-weight:600;color:var(--text-0);margin-bottom:6px;">${taskMap[id].task}</div>
          ${taskMap[id].lastMsg ? `<div style="font-size:12px;color:var(--text-2);line-height:1.4;">â†³ ${taskMap[id].lastMsg}</div>` : ''}
          <div style="font-size:10px;color:var(--text-3);margin-top:6px;">ìƒíƒœ: ${taskMap[id].status === 'responded' ? 'âœ… ì‘ë‹µ ì™„ë£Œ' : 'â³ ëŒ€ê¸° ì¤‘'}</div>
        </div>
      </div>` : ''}
      <div class="m-sec">
        <div class="m-sec-t">âš™ï¸ í•˜íŠ¸ë¹„íŠ¸</div>
        <div style="background:var(--bg-2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:12px 16px;font-size:13px;">
          ${hbAgent?.enabled
            ? `í™œì„± Â· ì£¼ê¸°: ${hbAgent.every}`
            : `<span style="color:var(--text-3);">ë¹„í™œì„± (í•˜íŠ¸ë¹„íŠ¸ êº¼ì§)</span>`}
        </div>
      </div>
      <div class="m-sec">
        <div class="m-sec-t">ğŸ’¬ ì„¸ì…˜ ì •ë³´</div>
        ${recent.length > 0
          ? recent.map(s => `
            <div style="background:var(--bg-2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:12px 16px;margin-bottom:8px;">
              <div style="font-size:13px;font-weight:600;margin-bottom:4px;">${s.displayName || s.key}</div>
              <div style="font-size:11px;color:var(--text-2);">ëª¨ë¸: ${s.model || model} Â· ì»¨í…ìŠ¤íŠ¸: ${fmtTokens(s.contextTokens || 0)}</div>
              <div style="display:flex;align-items:center;gap:10px;margin-top:8px;">
                <div style="flex:1;height:6px;background:var(--bg-0);border-radius:3px;overflow:hidden;">
                  <div style="height:100%;width:${s.percentUsed || 0}%;background:${(s.percentUsed||0) > 70 ? 'var(--red)' : 'var(--green)'};border-radius:3px;"></div>
                </div>
                <span style="font-size:12px;font-weight:600;font-family:'JetBrains Mono',monospace;">${s.percentUsed || 0}%</span>
              </div>
            </div>
          `).join('')
          : '<div style="color:var(--text-3);font-size:13px;">í™œì„± ì„¸ì…˜ ì—†ìŒ</div>'}
      </div>
      <div class="m-sec">
        <div class="m-sec-t">ğŸ”‘ ë„êµ¬ ê¶Œí•œ</div>
        <div class="chip-grid">
          ${ALL_TOOLS.map(t => {
            const denied = m.deny.includes(t);
            return `<div class="chip ${denied ? 'no' : 'ok'}">${denied ? 'âœ—' : 'âœ“'} ${t}</div>`;
          }).join('')}
        </div>
      </div>
      <div class="m-sec">
        <div class="m-sec-t">ğŸ“Š í† í° ì‚¬ìš©ëŸ‰</div>
        <div class="mini-grid">
          <div class="mini"><div class="l">ì…ë ¥ í† í°</div><div class="v">${fmtTokens(inputTokens)}</div></div>
          <div class="mini"><div class="l">ì¶œë ¥ í† í°</div><div class="v">${fmtTokens(outputTokens)}</div></div>
          <div class="mini"><div class="l">ì´ í† í°</div><div class="v">${fmtTokens(totalTokens)}</div></div>
          <div class="mini"><div class="l">ì»¨í…ìŠ¤íŠ¸ ì‚¬ìš©ë¥ </div><div class="v" style="color:${pctUsed > 70 ? 'var(--red)' : 'var(--green)'};">${pctUsed}%</div></div>
        </div>
      </div>
    </div>
  `;
  document.getElementById('modalBg').classList.add('show');
}

function closeModal(e) {
  if (e && e.target !== document.getElementById('modalBg')) return;
  document.getElementById('modalBg').classList.remove('show');
}

// ===== HELPERS =====
function getMeta(id) { return META[id] || { name: id, emoji: 'â“', role: id, model: 'unknown', modelId: '', color: '#666', origin: '-', deny: [] }; }
function setConn(state) {
  const dot = document.getElementById('connDot');
  const label = document.getElementById('connLabel');
  dot.className = 'dot ' + state;
  const labels = { on: STATIC_MODE ? 'GCS ì •ì ' : `Gateway :${GW_PORT}`, off: 'ì—°ê²° ëŠê¹€', connecting: STATIC_MODE ? 'ë¡œë”© ì¤‘...' : 'ì—°ê²° ì¤‘...' };
  label.textContent = labels[state];
}
function fmtTokens(n) {
  if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
  if (n >= 1000) return (n / 1000).toFixed(1) + 'K';
  return String(n);
}
function buildSessionMap() {
  const byAgent = gwData.status?.sessions?.byAgent || [];
  const map = {};
  byAgent.forEach(a => { if (a.recent?.length) map[a.agentId] = a.recent[0]; });
  return map;
}

// Gateway restart via conn badge
let gwRestarting = false;
function onConnBadgeClick() {
  if (STATIC_MODE) return; // GCS ëª¨ë“œì—ì„œëŠ” ì¬ì‹œì‘ ì—†ìŒ
  if (connected) return; // already connected, no action needed
  if (gwRestarting) return; // already restarting
  gwRestarting = true;
  const badge = document.getElementById('connBadge');
  const label = document.getElementById('connLabel');
  badge.classList.add('restarting');
  label.textContent = 'Gateway ì‹œì‘ ì¤‘...';
  fetch('/api/gateway/restart', { method: 'POST' })
    .then(function(r) { return r.json(); })
    .then(function(data) {
      if (data.ok) {
        label.textContent = 'ì¬ì‹œì‘ ì™„ë£Œ, ì—°ê²° ì¤‘...';
        // Give gateway a moment to start, then reconnect
        setTimeout(function() {
          gwRestarting = false;
          badge.classList.remove('restarting');
          connect();
        }, 3000);
      } else {
        label.textContent = 'ì‹œì‘ ì‹¤íŒ¨: ' + (data.stderr || data.error || 'unknown');
        gwRestarting = false;
        badge.classList.remove('restarting');
      }
    })
    .catch(function(err) {
      label.textContent = 'ì„œë²„ ì—°ê²° ì‹¤íŒ¨';
      gwRestarting = false;
      badge.classList.remove('restarting');
    });
}

// Clock
function tick() {
  const now = new Date();
  document.getElementById('clock').textContent = now.toLocaleTimeString('ko-KR', { hour:'2-digit', minute:'2-digit', second:'2-digit', hour12: false });
}
setInterval(tick, 1000); tick();

// Periodic refresh (WebSocket ëª¨ë“œ: 15ì´ˆ/10ì´ˆ, GCS ëª¨ë“œëŠ” fetchStaticì—ì„œ 2ë¶„)
if (!STATIC_MODE) {
  setInterval(() => { if (connected) fetchAll(); }, 15000);
  setInterval(() => { if (connected && rendered) fetchTasks(); }, 10000);
}

// Keyboard
document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });

// Resize
window.addEventListener('resize', () => { if (gwData.cost) renderChart(); });

// Start
connect();
</script>
</body>
</html>
